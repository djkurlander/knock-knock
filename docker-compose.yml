services:
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    restart: unless-stopped

  honeypot-monitor:
    image: ghcr.io/djkurlander/knock-knock:latest
    build: .  # Used when running: docker compose up --build
    command: bash -c "python -u honeypot.py 2>&1 | python -u monitor.py"
    environment:
      - REDIS_HOST=redis
    ports:
      - "22:22"
    volumes:
      - ./data:/app/data
      - /usr/share/GeoIP:/usr/share/GeoIP:ro
    depends_on:
      - redis
    restart: unless-stopped

  web:
    image: ghcr.io/djkurlander/knock-knock:latest
    build: .  # Used when running: docker compose up --build
    command:
      - sh
      - -c
      - |
        if [ "$$ENABLE_SSL" = 'true' ]; then
          exec python -m uvicorn main:app --host 0.0.0.0 --port 443 \
            --ssl-keyfile /app/certs/key.pem --ssl-certfile /app/certs/cert.pem \
            --proxy-headers --forwarded-allow-ips='*' --workers 2;
        else
          exec python -m uvicorn main:app --host 0.0.0.0 --port 80 \
            --proxy-headers --forwarded-allow-ips='*' --workers 2;
        fi
    environment:
      - REDIS_HOST=redis
    ports:
      - "80:80"
    volumes:
      - ./data:/app/data
      - /usr/share/GeoIP:/usr/share/GeoIP:ro
    depends_on:
      - redis
    restart: unless-stopped

volumes:
  redis-data:
