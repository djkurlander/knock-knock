<!DOCTYPE html>
<html>
<head>
    <title>Knock-Knock.net | Live Intruder Map</title>
    <link rel="icon" type="image/png" href="static/robot1.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. GLOBAL & SHARED STYLES --- */
        :root { 
            --neon-green: #00ff41; 
            --warning-yellow: #ffcc00; 
            --hazard-red: #ff3333; 
            --data-blue: #00fbff; 
            --user-magenta: #ff00ff; 
            --bg-dark: #0a0a0a;
            --ui-label: #ffcc00;
            --ui-grey-dim: #707070;
        }
        
        html, body { 
            background: var(--bg-dark); 
            color: var(--neon-green); 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0; 
            width: 100vw; 
            height: 100vh;      /* HARD LOCK: Kill the ghost at the bottom */
            overflow: hidden;   /* Forbidden to scroll the window itself */
            font-size: 16px;
        }
        
        img.emoji { height: 1.4em; width: 1.4em; margin: 0 .1em; vertical-align: -0.2em; }

        h2 {
            color: var(--neon-green); border-bottom: 2px solid #333; font-size: 1.4em;
            margin: 0 0 12px 0; padding-bottom: 3px; text-transform: uppercase; letter-spacing: 2px;
        }

        .stat-value { color: var(--warning-yellow); font-weight: bold; }
        .stat-label { color: var(--ui-label); font-size: 0.9em; text-transform: uppercase; }

        .knock { margin-bottom: 10px; padding: 5px 0 10px 0; border-bottom: 1px solid #1a1a1a; font-size: 1.1em; line-height: 1.5; }
        .knock-meta { font-size: 0.9em; }
        .knock-pass { color: var(--hazard-red); font-weight: bold; }

        .bar-row { margin-bottom: 12px; padding: 8px 12px; border-radius: 4px; border: 1px solid transparent; }
        .bar-label { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; margin-bottom: 6px; gap: 10px; }
        .bar-label span:first-child { display: flex; align-items: center; gap: 0.3em; }
        .knock-location { display: flex; align-items: center; gap: 0.3em; }
        .bar-bg { background: #1a1a1a; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { background: var(--neon-green); height: 100%; transition: width 1s; opacity: 0.7; }
        
        .shame-fill { background: var(--warning-yellow); }
        .password-fill { background: var(--hazard-red); }
        .provider-fill { background: var(--data-blue); }
        .user-fill { background: var(--user-magenta); }

        @keyframes pulse-green { 0% { background: rgba(0, 255, 65, 0.4); } 100% { background: transparent; } }
        .new-knock-flash { animation: pulse-green 3s forwards; }

        .status-dot { height: 14px; width: 14px; border-radius: 50%; background: var(--hazard-red); display: inline-block; vertical-align: 0.2em; margin-left: 10px; }
        .status-online { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }

        .globe-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background: rgba(0, 0, 0, 0.5) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer;
        }

        /* --- 2. DESKTOP VIEW (> 800px) --- */
        @media (min-width: 801px) {
            #mobile-layout { display: none !important; }

            #desktop-layout {
                display: flex;
                flex-direction: column;
                height: 100vh;
                padding: 15px 30px 30px 30px;
                box-sizing: border-box;
                overflow: hidden;
            }

            .d-header { flex: 0 0 auto; margin-bottom: 0; }
            .d-header h1 { font-size: 2.2em; margin: 0 0 5px 0; }

            .d-nav {
                display: flex; gap: 40px; margin-bottom: 10px;
                border-bottom: 1px solid #222; padding-bottom: 10px;
            }
            .d-nav-item { 
                color: var(--ui-grey-dim); font-size: 1.6em; cursor: pointer; 
                display: flex; align-items: center; gap: 10px; transition: 0.3s;
            }
            .d-nav-item span { font-size: 0.5em; font-weight: bold; letter-spacing: 1px; }
            .d-nav-item.active { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }

            .d-stats { font-size: 1em; }
            .d-stats:first-of-type { margin-top: 5px; }
            .d-stats .stat-label { font-size: 1em; }
            .d-stats .stat-value { font-size: 1em; }

            .d-header-content { display: flex; justify-content: space-between; align-items: flex-start; }
            .d-header-left { flex: 1; }
            .d-header-right { flex: 0 0 110px; display: flex; align-items: center; justify-content: center; }
            #d-globe-container { width: 110px; height: 110px; cursor: pointer; }
            #d-globe-container canvas { width: 100% !important; height: 100% !important; }

            .d-grid { 
                flex: 1;
                display: flex; gap: 15px; width: 100%; 
                overflow: hidden; margin-top: 25px;
                min-height: 0; /* Flexbox scroll fix */
            }
            
            .d-box {
                flex: 0 0 14%; /* Fixed width for standard panes */
                height: 100%;
                border: 1px solid #333;
                background: #0f0f0f;
                padding: 16px;
                display: flex;
                flex-direction: column;
                cursor: pointer;
                box-sizing: border-box;
                /* SLOW-IN-SLOW-OUT TRANSITION */
                transition: all 1.0s cubic-bezier(0.65, 0, 0.35, 1);
            }
            
            #d-box-feed { 
                flex: 0 0 35%; /* Feed stays wide regardless of position */
            }
            
            .d-box.is-active { 
                border-color: var(--neon-green); 
                box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.05), 0 0 10px rgba(0, 255, 65, 0.1); 
            }

            .d-content { flex: 1; overflow-y: auto; font-size: 0.75em; scrollbar-gutter: stable; margin-right: -10px; padding-right: 6px; }
            .d-content .knock { margin-bottom: 4px; padding: 3px 0 7px 0; line-height: 1.3; }
            .d-content .bar-row { margin-bottom: 0; padding: 6px 0 10px 0; }
            .d-content .bar-label { margin-bottom: 4px; }
            .d-box h2 { font-size: 1.1em; }
            .d-content::-webkit-scrollbar { width: 2px; background: transparent; }
            .d-content::-webkit-scrollbar-thumb { background: transparent !important; border-radius: 10px; transition: background 0.15s ease; }
            .d-box:hover .d-content::-webkit-scrollbar-thumb { background: #2a2a2a !important; border: 1px solid #3a3a3a; }
            .d-box:hover .d-content::-webkit-scrollbar-thumb:hover { background: var(--neon-green) !important; }
        }

        /* --- 3. MOBILE VIEW (<= 800px) --- */
        @media (max-width: 800px) {
            #desktop-layout { display: none !important; }
            
            #mobile-layout { 
                display: flex; height: 100dvh; width: 100vw; 
                flex-direction: column; overflow: hidden; 
            }
            
            .m-header { flex: 0 0 auto; padding: 15px; background: #0a0a0a; border-bottom: 1px solid #222; }
            .m-header-content { display: flex; justify-content: space-between; align-items: flex-start; }
            .m-header-left { flex: 1; }
            .m-header-right { flex: 0 0 80px; display: flex; align-items: center; justify-content: center; }
            #globe-container { width: 85px; height: 85px; cursor: pointer; }
            #globe-container canvas { width: 100% !important; height: 100% !important; }
            .m-header h1 { font-size: 1.36em; margin: 0; }
            .m-header .status-dot { vertical-align: 0.075em; }
            .m-stat-row { display: flex; font-size: 0.85em; }
            .m-stat-row:first-of-type { margin-top: 10px; }
            .m-stat-row .stat-label { font-size: 1em; }
            .m-stat-row .stat-value { font-size: 1em; }
            .m-pane h2 { font-size: 1.02em; }

            .m-progress-container { height: 4px; background: #000; width: 100%; }
            #m-progress-bar { height: 100%; width: 0%; background: var(--neon-green); box-shadow: 0 0 12px var(--neon-green); }

            .m-viewport { flex: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
            .m-pane { width: 100vw; height: 100%; flex-shrink: 0; scroll-snap-align: start; display: flex; flex-direction: column; padding: 20px 10px 20px 20px; box-sizing: border-box; background: #0f0f0f; border-right: 1px solid #1a1a1a; }
            
            .m-content {
                flex: 1; overflow-y: auto;
                padding-right: 5px;
                font-size: 0.85em;
            }
            .m-content .knock { margin-bottom: 6px; padding: 4px 0 8px 0; line-height: 1.3; }
            .m-content .bar-row { margin-bottom: 0; padding: 5px 0 8px 0; }
            .m-content .bar-label { margin-bottom: 4px; }
            .m-content .knock-location img.emoji,
            .m-content .bar-label img.emoji { vertical-align: middle; }

            #m-viewport::-webkit-scrollbar { display: none !important; }

            .m-footer { flex: 0 0 auto; background: #0a0a0a; border-top: 1px solid #222; padding-bottom: env(safe-area-inset-bottom); }
            .m-dots { display: flex; justify-content: center; gap: 15px; padding: 12px 0; }
            .dot { width: 10px; height: 10px; border-radius: 50%; background: #222; transition: 0.3s; cursor: pointer; }
            .dot.active { background: var(--neon-green); transform: scale(1.4); box-shadow: 0 0 8px var(--neon-green); }

            .m-nav { display: flex; justify-content: space-around; padding: 15px 0; border-top: 2px solid var(--neon-green); background: #000; }
            .nav-item { color: var(--ui-grey-dim); font-size: 1.8em; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; }
            .nav-item span { font-size: 0.45em; margin-top: 4px; font-weight: bold; }
            .nav-item.active { color: var(--neon-green); text-shadow: 0 0 12px var(--neon-green); transform: translateY(-3px); }
        }
    </style>
</head>
<body>

<div id="desktop-layout">
    <div class="d-header">
        <nav class="d-nav">
            <div class="d-nav-item active" onclick="dJump(0)">üì¢<span>FEED</span></div>
            <div class="d-nav-item" onclick="dJump(1)">üåê<span>GEO</span></div>
            <div class="d-nav-item" onclick="dJump(2)">üë§<span>USER</span></div>
            <div class="d-nav-item" onclick="dJump(3)">üîë<span>PASS</span></div>
            <div class="d-nav-item" onclick="dJump(4)">üîå<span>ISP</span></div>
            <div class="d-nav-item" onclick="dJump(5)">üìã<span>INFO</span></div>
        </nav>

        <div class="d-header-content">
            <div class="d-header-left">
                <h1>BOTS ARE KNOCKING <span class="status-dot"></span></h1>
                <div style="font-size: 1em; color: var(--neon-green); margin-top: -8px; margin-bottom: 12px; font-style: italic;">... BUT THEY CAN'T COME IN.</div>
                <div class="d-stats">
                    <span class="stat-label">Knocks:</span>&nbsp;<span id="d-total" class="stat-value">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="stat-label">Per Min:</span>&nbsp;<span id="d-kpm" class="stat-value">0.00</span>
                </div>
                <div class="d-stats">
                    <span class="stat-label">SINCE LAST KNOCK:</span>&nbsp;<span id="d-since" class="stat-value">-</span>
                </div>
            </div>
            <div class="d-header-right">
                <div id="d-globe-container"></div>
            </div>
        </div>
    </div>
    
    <div class="d-grid" id="d-slider-container">
        <div class="d-box" id="d-box-feed" onclick="dJump(0)"><h2>LIVE FEED: LOGIN ATTEMPTS</h2><div id="d-feed" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(1)"><h2>COUNTRIES</h2><div id="d-shame" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(2)"><h2>USERNAMES</h2><div id="d-user" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(3)"><h2>PASSWORDS</h2><div id="d-pass" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(4)"><h2>ISP's</h2><div id="d-prov" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(5)"><h2>INFO</h2><div id="d-details" class="d-content"></div></div>
    </div>
</div>

<div id="mobile-layout">
    <div class="m-header">
        <div class="m-header-content">
            <div class="m-header-left">
                <h1>BOTS ARE KNOCKING <span class="status-dot"></span></h1>
                <div style="font-size: 0.85em; color: var(--neon-green); margin-top: -2px; margin-bottom: 8px; font-style: italic;">... BUT THEY CAN'T COME IN.</div>
                <div class="m-stat-row">
                    <span class="stat-label">Knocks:</span>&nbsp;<span id="m-total" class="stat-value">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="stat-label">Per Min:</span>&nbsp;<span id="m-kpm" class="stat-value">0.00</span>
                </div>
                <div class="m-stat-row">
                    <span class="stat-label">SINCE LAST KNOCK:</span>&nbsp;<span id="m-since" class="stat-value">-</span>
                </div>
            </div>
            <div class="m-header-right">
                <div id="globe-container"></div>
            </div>
        </div>
    </div>
    <div class="m-progress-container"><div id="m-progress-bar"></div></div>
    <div class="m-viewport" id="m-viewport">
        <div class="m-pane" id="m-pane-feed"><h2>LIVE FEED: LOGIN ATTEMPTS</h2><div id="m-feed" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-shame"><h2>COUNTRIES</h2><div id="m-shame" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-user"><h2>USERNAMES</h2><div id="m-user" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-pass"><h2>PASSWORDS</h2><div id="m-pass" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-prov"><h2>ISP's</h2><div id="m-prov" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-details"><h2>INFO</h2><div id="m-details" class="m-content"></div></div>
    </div>
    <div class="m-footer">
        <div class="m-dots">
            <div class="dot active" onclick="jump(0)"></div><div class="dot" onclick="jump(1)"></div><div class="dot" onclick="jump(2)"></div><div class="dot" onclick="jump(3)"></div><div class="dot" onclick="jump(4)"></div><div class="dot" onclick="jump(5)"></div>
        </div>
        <nav class="m-nav">
            <div class="nav-item active" onclick="jump(0)">üì¢<span>FEED</span></div>
            <div class="nav-item" onclick="jump(1)">üåê<span>GEO</span></div>
            <div class="nav-item" onclick="jump(2)">üë§<span>USER</span></div>
            <div class="nav-item" onclick="jump(3)">üîë<span>PASS</span></div>
            <div class="nav-item" onclick="jump(4)">üîå<span>ISP</span></div>
            <div class="nav-item" onclick="jump(5)">üìã<span>INFO</span></div>
        </nav>
    </div>
</div>

<script>
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;
    let ws;
    let lastKnockTime = null;
    let mobileGlobe = null;
    let desktopGlobe = null;
    let lastLat = null;
    let lastLng = null;
    let countriesData = null;

    // Load countries GeoJSON on startup for fullscreen mode
    fetch('/static/countries.geojson')
        .then(res => res.json())
        .then(data => {
            countriesData = data.features;
            console.log('Countries data loaded:', countriesData.length, 'features');
        });

    function createGlobe(container, size) {
        const g = Globe()
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-day.jpg')
            .backgroundColor('rgba(0,0,0,0)')
            .showAtmosphere(false)
            .width(size)
            .height(size)
            .pointsData([])
            .pointAltitude(0.01)
            .pointColor(() => '#ff0000')
            .pointRadius(1.5)
            (container);

        g.controls().enableZoom = false;
        g.controls().enablePan = false;
        g.controls().autoRotate = false;
        g.pointOfView({ lat: 0, lng: 0, altitude: 1.4 });
        return g;
    }

    function addGlobeClickHandler(container, onClick) {
        let startX, startY;
        container.addEventListener('mousedown', (e) => { startX = e.clientX; startY = e.clientY; });
        container.addEventListener('click', (e) => {
            const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
            if (dist < 5) onClick();
        });
    }

    function initGlobes() {
        const mobileContainer = document.getElementById('globe-container');
        const desktopContainer = document.getElementById('d-globe-container');

        if (mobileContainer && window.innerWidth <= 800) {
            mobileGlobe = createGlobe(mobileContainer, 85);
            addGlobeClickHandler(mobileContainer, () => toggleGlobeFullscreen(mobileContainer, mobileGlobe, 85));
        }
        if (desktopContainer && window.innerWidth > 800) {
            desktopGlobe = createGlobe(desktopContainer, 110);
            addGlobeClickHandler(desktopContainer, () => toggleGlobeFullscreen(desktopContainer, desktopGlobe, 120));
        }
    }

    let globeIsFullscreen = false;

    function toggleGlobeFullscreen(container, globe, smallSize) {
        if (!globe) return;

        const isDesktop = window.innerWidth > 800;
        globeIsFullscreen = !globeIsFullscreen;

        if (globeIsFullscreen) {
            // Hide during transition
            container.style.visibility = 'hidden';
            container.classList.add('globe-fullscreen');

            const size = Math.min(window.innerWidth, window.innerHeight) * 0.9;
            globe.width(size).height(size);

            // Add neon country outlines for fullscreen
            if (countriesData) {
                globe.polygonsData(countriesData);
                globe.polygonCapColor(() => 'rgba(0, 0, 0, 0)');
                globe.polygonSideColor(() => 'rgba(0, 0, 0, 0)');
                globe.polygonStrokeColor(() => '#00ff41');
                globe.polygonAltitude(0.002);
            }
            // Reduce marker size on desktop when zoomed
            if (isDesktop) {
                globe.pointRadius(0.75);
            }

            // Show after globe has resized
            setTimeout(() => { container.style.visibility = 'visible'; }, 100);
        } else {
            // Clear outlines first while still in fullscreen position
            globe.polygonsData([]);
            globe.pointRadius(1.5);

            container.style.visibility = 'hidden';

            setTimeout(() => {
                container.classList.remove('globe-fullscreen');
                globe.width(smallSize).height(smallSize);
                // Wait for layout to settle before showing
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        container.style.visibility = 'visible';
                    });
                });
            }, 100);
        }

        // Re-center on current location
        if (lastLat !== null) {
            globe.pointOfView({ lat: lastLat, lng: lastLng, altitude: 1.4 }, 500);
        }
    }

    function rotateGlobeToLocation(lat, lng) {
        if (lat === null || lng === null) return;
        lastLat = lat;
        lastLng = lng;
        const point = [{ lat: lat, lng: lng }];
        if (mobileGlobe) {
            mobileGlobe.pointsData(point);
            mobileGlobe.pointOfView({ lat: lat, lng: lng, altitude: 1.4 }, 1000);
        }
        if (desktopGlobe) {
            desktopGlobe.pointsData(point);
            desktopGlobe.pointOfView({ lat: lat, lng: lng, altitude: 1.4 }, 1000);
        }
    }

    // Handle resize across breakpoint
    let lastWidth = window.innerWidth;
    window.addEventListener('resize', () => {
        const isMobile = window.innerWidth <= 800;
        const wasMobile = lastWidth <= 800;

        if (isMobile !== wasMobile) {
            // Crossed the breakpoint
            const mobileContainer = document.getElementById('globe-container');
            const desktopContainer = document.getElementById('d-globe-container');

            if (isMobile && !mobileGlobe && mobileContainer) {
                mobileContainer.innerHTML = '';
                mobileGlobe = createGlobe(mobileContainer, 85);
                if (lastLat !== null) rotateGlobeToLocation(lastLat, lastLng);
            } else if (!isMobile && !desktopGlobe && desktopContainer) {
                desktopContainer.innerHTML = '';
                desktopGlobe = createGlobe(desktopContainer, 110);
                if (lastLat !== null) rotateGlobeToLocation(lastLat, lastLng);
            }
        }
        lastWidth = window.innerWidth;
    });

    setInterval(() => {
        if (lastKnockTime) {
            const secs = Math.floor(Date.now() / 1000 - lastKnockTime) + 's';
            document.getElementById('m-since').innerText = secs;
            document.getElementById('d-since').innerText = secs;
        }
    }, 1000);

    // MOBILE NAVIGATION
    function jump(idx) {
        const vp = document.getElementById('m-viewport');
        vp.scrollTo({ left: idx * vp.clientWidth, behavior: 'smooth' });
    }

    // DESKTOP ROTATION LOGIC
    function dJump(idx) {
        const container = document.getElementById('d-slider-container');
        const boxes = Array.from(container.children);
        const navItems = document.querySelectorAll('.d-nav-item');

        navItems.forEach((item, i) => item.classList.toggle('active', i === idx));

        boxes.forEach((box, i) => {
            let newOrder = (i - idx + boxes.length) % boxes.length;
            box.style.order = newOrder + 1;
            box.classList.toggle('is-active', i === idx);
        });
    }

    const getFlag = (iso) => {
        if (iso === 'XX' || !iso) return 'üè¥‚Äç‚ò†Ô∏è';
        return iso.toUpperCase().replace(/./g, char => String.fromCodePoint(char.charCodeAt(0) + 127397));
    };

    function renderBars(prefix, data, colorClass = '', useFlags = false) {
        ['d-', 'm-'].forEach(layout => {
            const container = document.getElementById(layout + prefix);
            if (!container) return;
            container.innerHTML = '';
            if (!data || data.length === 0) return;
            const max = data[0].count;
            data.forEach(item => {
                const pct = (item.count / max) * 100;
                const label = useFlags ? `${getFlag(item.iso)} ${item.country}` : (item.label || item.country);
                const rawId = useFlags ? item.iso : (item.label || item.country || item.isp);
                const div = document.createElement('div');
                div.className = 'bar-row';
                div.setAttribute('data-id', `${prefix}-${rawId}`);
                div.setAttribute('data-count', item.count);
                div.innerHTML = `<div class="bar-label"><span>${label}</span><span style="color:#ffcc00">${item.count}</span></div><div class="bar-bg"><div class="bar-fill ${colorClass}" style="width: ${pct}%"></div></div>`;
                container.appendChild(div);
                if (useFlags) twemoji.parse(div);
            });
        });
    }

    function incrementAndSort(prefix, id) {
        ['d-', 'm-'].forEach(layout => {
            const container = document.getElementById(layout + prefix);
            if (!container) return;
            const uniqueId = `${prefix}-${id}`;
            const row = container.querySelector(`.bar-row[data-id="${CSS.escape(uniqueId)}"]`);
            if (!row) return;

            const countSpan = row.querySelector('span:last-child');
            let newCount = (parseInt(countSpan.innerText) || 0) + 1;
            countSpan.innerText = newCount;
            row.setAttribute('data-count', newCount);

            if (row.highlightAnimation) row.highlightAnimation.cancel();
            row.highlightAnimation = row.animate([
                { background: 'rgba(0, 255, 65, 0.4)' },
                { background: 'transparent' }
            ], { duration: 3000, easing: 'ease' });

            const rows = Array.from(container.children);
            rows.sort((a, b) => (parseInt(b.getAttribute('data-count')) || 0) - (parseInt(a.getAttribute('data-count')) || 0));
            const max = parseInt(rows[0].getAttribute('data-count')) || 1;
            rows.forEach(el => {
                container.appendChild(el); 
                el.querySelector('.bar-fill').style.width = ((parseInt(el.getAttribute('data-count')) || 0) / max * 100) + '%';
            });
        });
    }

    function renderKnock(d, isNew = true) {
        const loc = (d.city === 'Unknown' || !d.city) ? `Somewhere in ${d.country}` : `${d.city}, ${d.country}`;
        
        const html = `
            <div class="knock-location"><strong>${getFlag(d.iso)}</strong> <strong>${loc}</strong></div>
            <span style="color:var(--ui-label)">user:</span> <span>${d.user}</span>
            <span style="color:var(--ui-label); margin-left:10px;">password:</span> <span class="knock-pass">${d.pass}</span><br>
            <span class="knock-meta"><span style="color:var(--ui-label)">ISP:</span> <span style="color:var(--data-blue)">${d.isp}</span> <span style="color:var(--ui-label); margin-left:10px;">IP:</span> <span style="color:var(--data-blue)">${d.ip}</span></span>
        `;
        
        ['d-feed', 'm-feed'].forEach(id => {
            const el = document.getElementById(id);
            const div = document.createElement('div');
            div.className = 'knock' + (isNew ? ' new-knock-flash' : '');
            div.innerHTML = html;
            if (isNew) el.prepend(div); else el.appendChild(div);
            twemoji.parse(div);
            if (el.children.length > 500) el.lastChild.remove();
        });
    }

    function connect() {
        if (ws) ws.close();
        ws = new WebSocket(wsUrl);
        ws.onopen = () => document.querySelectorAll('.status-dot').forEach(d => d.classList.add('status-online'));
        ws.onclose = () => { document.querySelectorAll('.status-dot').forEach(d => d.classList.remove('status-online')); setTimeout(connect, 3000); };
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const d = msg.data;
            if (msg.type === 'new_knock') {
                lastKnockTime = Math.floor(Date.now() / 1000);
                document.getElementById('m-since').innerText = '0s';
                document.getElementById('d-since').innerText = '0s';
                renderKnock(d, true);
                ['d-total', 'm-total'].forEach(id => document.getElementById(id).innerText = d.total_global.toLocaleString());
                ['d-kpm', 'm-kpm'].forEach(id => document.getElementById(id).innerText = d.kpm);
                incrementAndSort('shame', d.iso);
                incrementAndSort('pass', d.pass);
                incrementAndSort('prov', d.isp);
                incrementAndSort('user', d.user);
                rotateGlobeToLocation(d.lat, d.lng);
            } 
            else if (msg.type === 'init_stats') {
                ['d-total', 'm-total'].forEach(id => document.getElementById(id).innerText = (d.total || 0).toLocaleString());
                ['d-kpm', 'm-kpm'].forEach(id => document.getElementById(id).innerText = d.kpm || '0.00');
                if (d.last_knock_time) {
                    lastKnockTime = d.last_knock_time;
                    const secs = Math.floor(Date.now() / 1000 - lastKnockTime) + 's';
                    document.getElementById('m-since').innerText = secs;
                    document.getElementById('d-since').innerText = secs;
                }
                if (d.last_lat !== null && d.last_lng !== null) {
                    rotateGlobeToLocation(d.last_lat, d.last_lng);
                }
                renderBars('shame', d.shame, 'shame-fill', true);
                renderBars('pass', d.top_passwords, 'password-fill');
                renderBars('prov', d.top_providers, 'provider-fill');
                renderBars('user', d.top_users, 'user-fill');
                if (d.history) { ['d-feed', 'm-feed'].forEach(id => document.getElementById(id).innerHTML = ''); d.history.forEach(k => renderKnock(k, false)); }
            }
        };
    }

    const vp = document.getElementById('m-viewport');
    vp.addEventListener('scroll', () => {
        const scrolled = (vp.scrollLeft / (vp.scrollWidth - vp.clientWidth)) * 100;
        document.getElementById('m-progress-bar').style.width = scrolled + '%';
    });

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const idx = Array.from(entry.target.parentNode.children).indexOf(entry.target);
                document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === idx));
                document.querySelectorAll('.nav-item').forEach((n, i) => n.classList.toggle('active', i === idx));
            }
        });
    }, { root: vp, threshold: 0.6 });
    document.querySelectorAll('.m-pane').forEach(p => observer.observe(p));

    window.addEventListener('load', () => {
        dJump(0);
        initGlobes();
    });
    connect();
</script>
</body>
</html>