<!DOCTYPE html>
<html>
<head>
    <title>Knock-Knock | Live Intruder Map</title>
    <link rel="icon" type="image/png" href="static/robot1.png">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <script src="https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/globe.gl"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. GLOBAL & SHARED STYLES --- */
        :root { 
            --neon-green: #00ff41; 
            --warning-yellow: #ffcc00; 
            --hazard-red: #ff1a1a; 
            --data-blue: #00fbff; 
            --user-magenta: #ff00ff;
            --ip-purple: #9d00ff;
            --bg-dark: #0a0a0a;
            --ui-label: #ffcc00;
            --ui-grey-dim: #707070;
        }
        
        html, body {
            background: var(--bg-dark);
            color: var(--neon-green);
            font-family: 'Inter', sans-serif;
            margin: 0; padding: 0;
            width: 100vw;
            height: 100dvh;
            height: -webkit-fill-available;  /* iOS fallback */
            overflow: hidden;
            font-size: 16px;
        }
        
        img.emoji { height: 1.4em; width: 1.4em; margin: 0 .1em; vertical-align: -0.2em; }

        h2 {
            color: var(--neon-green); border-bottom: 2px solid #333; font-size: 1.4em;
            margin: 0 0 12px 0; padding-bottom: 3px; text-transform: uppercase; letter-spacing: 2px;
        }

        .stat-value { color: var(--warning-yellow); font-weight: bold; }
        .stat-label { color: var(--ui-label); font-size: 0.9em; text-transform: uppercase; }

        .knock { margin-bottom: 10px; padding: 5px 0 10px 0; border-bottom: 1px solid #1a1a1a; font-size: 1.1em; line-height: 1.5; }
        .knock-meta { font-size: 0.9em; }
        .knock-pass { color: var(--neon-green); }

        .bar-row { margin-bottom: 12px; padding: 8px 12px; border-radius: 4px; border: 1px solid transparent; }
        .bar-label { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; margin-bottom: 6px; gap: 10px; }
        .bar-label span:first-child { display: flex; align-items: center; gap: 0.3em; }
        .knock-location { display: flex; align-items: center; gap: 0.3em; }
        .bar-bg { background: #1a1a1a; height: 10px; border-radius: 5px; overflow: hidden; }
        .bar-fill { background: var(--neon-green); height: 100%; transition: width 1s; opacity: 0.7; }
        
        .loc-fill { background: var(--warning-yellow); }
        .password-fill { background: var(--hazard-red); }
        .provider-fill { background: var(--data-blue); }
        .user-fill { background: var(--user-magenta); }
        .ip-fill { background: var(--ip-purple); }

        @keyframes pulse-green { 0% { background: rgba(0, 255, 65, 0.4); } 100% { background: transparent; } }
        .new-knock-flash { animation: pulse-green 3s forwards; }

        .status-dot { height: 14px; width: 14px; border-radius: 50%; background: var(--hazard-red); display: inline-block; vertical-align: 0.2em; margin-left: 10px; }
        .status-online { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }

        /* --- 2. DESKTOP VIEW (> 800px) --- */
        @media (min-width: 801px) {
            #mobile-layout { display: none !important; }

            #desktop-layout {
                display: flex;
                flex-direction: column;
                height: 100vh;
                padding: 15px 30px 30px 30px;
                box-sizing: border-box;
                overflow: hidden;
            }

            .d-header { flex: 0 0 auto; margin-bottom: 0; }
            .d-header h1 { font-size: 2.2em; margin: 0 0 5px 0; }

            .d-nav {
                display: flex; flex-wrap: wrap; gap: 16px 26px; margin-bottom: 10px;
                border-bottom: 1px solid #222; padding-bottom: 10px;
            }
            .d-nav-item {
                color: var(--ui-grey-dim); font-size: 1.6em; cursor: pointer;
                display: flex; align-items: center; gap: 4px; transition: 0.3s;
                flex: 0 0 auto;
            }
            .d-nav-item span { font-size: 0.5em; font-weight: bold; letter-spacing: 1px; }
            .d-nav-item.active { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }

            .d-stats { font-size: 1em; }
            .d-stats:first-of-type { margin-top: 5px; }
            .d-stats .stat-label { font-size: 1em; }
            .d-stats .stat-value { font-size: 1em; }

            .d-header-content { display: flex; justify-content: space-between; align-items: flex-start; }
            .d-header-left { flex: 1; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
            .d-header-right { flex: 0 0 110px; display: flex; align-items: center; justify-content: center; }
            #d-globe-container { width: 110px; height: 110px; cursor: pointer; }
            #d-globe-container canvas { width: 100% !important; height: 100% !important; }

            .d-grid { 
                flex: 1;
                display: flex; gap: 15px; width: 100%; 
                overflow: hidden; margin-top: 25px;
                min-height: 0; /* Flexbox scroll fix */
            }
            
            .d-box {
                flex: 0 0 250px;
                height: 100%;
                border: 1px solid #333;
                background: #0f0f0f;
                padding: 16px;
                display: flex;
                flex-direction: column;
                cursor: pointer;
                box-sizing: border-box;
                /* SLOW-IN-SLOW-OUT TRANSITION */
                transition: all 1.0s cubic-bezier(0.65, 0, 0.35, 1);
            }

            #d-box-feed {
                flex: 0 0 425px;
            }
            #d-box-info {
                flex: 0 0 340px;
            }
            #d-box-globe {
                flex: 0 0 420px;
            }
            #d-box-jokes {
                flex: 0 0 275px;
            }
            #d-box-trivia {
                flex: 0 0 300px;
            }
            #d-globe-pane {
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: hidden;
                position: relative;
                scrollbar-gutter: auto;
                margin-right: 0;
                padding-right: 0;
            }
            #d-globe-pane.glow-active {
                background: radial-gradient(circle closest-side, transparent 0%, transparent var(--globe-edge, 84%), rgba(0,255,65,0.15) var(--globe-edge, 84%), transparent var(--glow-outer, 100%));
            }
            #d-globe-pane.glow-pulse::after { animation: globe-glow-pulse 2.5s ease-out forwards; }
            
            .d-box.is-active { 
                border-color: var(--neon-green); 
                box-shadow: inset 0 0 20px rgba(0, 255, 65, 0.05), 0 0 10px rgba(0, 255, 65, 0.1); 
            }

            .d-content { flex: 1; overflow-y: auto; font-size: 0.75em; scrollbar-gutter: stable; margin-right: -10px; padding-right: 6px; }
            .d-content .knock { margin-bottom: 4px; padding: 3px 0 7px 0; line-height: 1.3; }
            .d-content .bar-row { margin-bottom: 0; padding: 6px 0 10px 0; }
            .d-content .bar-label { margin-bottom: 4px; }
            .d-box h2 { font-size: 1.1em; }
            .d-content::-webkit-scrollbar { width: 2px; background: transparent; }
            .d-content::-webkit-scrollbar-thumb { background: transparent !important; border-radius: 10px; transition: background 0.15s ease; }
            .d-box:hover .d-content::-webkit-scrollbar-thumb { background: #2a2a2a !important; border: 1px solid #3a3a3a; }
            .d-box:hover .d-content::-webkit-scrollbar-thumb:hover { background: var(--neon-green) !important; }
        }

        /* --- 3. MOBILE VIEW (<= 800px) --- */
        @media (max-width: 800px) {
            #desktop-layout { display: none !important; }
            
            #mobile-layout {
                display: flex;
                width: 100vw;
                height: 100dvh;
                min-height: -webkit-fill-available;  /* iOS fallback */
                flex-direction: column;
                overflow: hidden;
            }
            
            .m-header { flex: 0 0 auto; padding: 15px; background: #0a0a0a; border-bottom: 1px solid #222; }
            .m-header-content { display: flex; justify-content: space-between; align-items: flex-start; }
            .m-header-left { flex: 1; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
            .m-header-right { flex: 0 0 80px; display: flex; align-items: center; justify-content: center; }
            #globe-container { width: 85px; height: 85px; cursor: pointer; }
            #globe-container canvas { width: 100% !important; height: 100% !important; }
            .m-header h1 { font-size: 1.36em; margin: 0; }
            .m-header .status-dot { vertical-align: 0.075em; }
            .m-stat-row { display: flex; font-size: 0.85em; }
            .m-stat-row:first-of-type { margin-top: 10px; }
            .m-stat-row .stat-label { font-size: 1em; }
            .m-stat-row .stat-value { font-size: 1em; }
            .m-pane h2 { font-size: 1.02em; }

            .m-progress-container { height: 4px; background: #000; width: 100%; }
            #m-progress-bar { height: 100%; width: 0%; background: var(--neon-green); box-shadow: 0 0 12px var(--neon-green); }

            .m-viewport { flex: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
            .m-pane { width: 100vw; height: 100%; flex-shrink: 0; scroll-snap-align: start; display: flex; flex-direction: column; padding: 20px 10px 20px 20px; box-sizing: border-box; background: #0f0f0f; border-right: 1px solid #1a1a1a; }
            
            .m-content {
                flex: 1; overflow-y: auto;
                padding-right: 5px;
                font-size: 0.85em;
            }
            .m-content .knock { margin-bottom: 6px; padding: 4px 0 8px 0; line-height: 1.3; }
            .m-content .bar-row { margin-bottom: 0; padding: 5px 0 8px 0; }
            .m-content .bar-label { margin-bottom: 4px; }
            .m-content .knock-location img.emoji,
            .m-content .bar-label img.emoji { vertical-align: middle; }

            #m-viewport::-webkit-scrollbar { display: none !important; }

            .m-footer { flex: 0 0 auto; background: #0a0a0a; border-top: 1px solid #222; padding-bottom: env(safe-area-inset-bottom); }
            .m-dots { display: flex; justify-content: center; gap: 15px; padding: 12px 0; }
            .dot { width: 10px; height: 10px; border-radius: 50%; background: #222; transition: 0.3s; cursor: pointer; }
            .dot.active { background: var(--neon-green); transform: scale(1.4); box-shadow: 0 0 8px var(--neon-green); }

            .m-nav-container { position: relative; border-top: 2px solid var(--neon-green); background: #000; }
            .m-nav-container::before, .m-nav-container::after { content: ''; position: absolute; top: 0; bottom: 0; width: 30px; z-index: 10; pointer-events: none; }
            .m-nav-container::before { left: 0; background: linear-gradient(to right, #000 0%, transparent 100%); }
            .m-nav-container::after { right: 0; background: linear-gradient(to left, #000 0%, transparent 100%); }
            .m-nav { display: flex; gap: 40px; padding: 15px 30px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
            .m-nav::-webkit-scrollbar { display: none; }
            .nav-item { color: var(--ui-grey-dim); font-size: 1.8em; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.2s; flex-shrink: 0; }
            .nav-item span { font-size: 0.45em; margin-top: 4px; font-weight: bold; }
            .nav-item.active { color: var(--neon-green); text-shadow: 0 0 12px var(--neon-green); transform: translateY(-3px); }

            #m-pane-globe { padding-left: 10px; padding-right: 10px; }
            #m-globe-pane { padding-right: 0; }
            #m-globe-pane.glow-active {
                background: radial-gradient(circle closest-side, transparent 0%, transparent var(--globe-edge, 84%), rgba(0,255,65,0.5) var(--globe-edge, 84%), transparent var(--glow-outer, 100%));
            }
            #m-globe-pane.glow-pulse::after { animation: globe-glow-pulse 3s ease-out forwards; }
        }
        .globe-pane { position: relative; overflow: hidden; }
        .globe-pane > * { position: relative; z-index: 1; }
        .globe-pane::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle closest-side, transparent 0%, transparent var(--globe-edge, 84%), rgba(0,255,65,1.0) var(--globe-edge, 84%), transparent 100%);
            opacity: 0;
            pointer-events: none;
            z-index: 0;
        }
        @keyframes globe-glow-pulse {
            0%   { opacity: 1; }
            100% { opacity: 0; }
        }

        .pane-globe-style-label {
            position: absolute; bottom: 8px; right: 8px; z-index: 2;
            display: flex; align-items: center; gap: 4px;
            color: var(--ui-label); font-size: 0.9em; font-family: monospace;
            user-select: none;
        }
        .pane-globe-style-btn {
            color: var(--neon-green); font-size: 1em; cursor: pointer;
            transition: color 0.2s, border-color 0.2s; user-select: none;
            border: 1px solid rgba(0,255,65,0.3); border-radius: 3px;
            padding: 2px 7px; font-family: monospace; letter-spacing: 1px;
            text-transform: uppercase;
        }
        @media (hover: hover) { .pane-globe-style-btn:hover { border-color: rgba(0,255,65,0.7); } }
    </style>
</head>
<body>

<div id="desktop-layout">
    <div class="d-header">
        <nav class="d-nav">
            <div class="d-nav-item active" onclick="dJump(0)">üì¢<span>FEED</span></div>
            <div class="d-nav-item" onclick="dJump(1)">üåç<span>GLOBE</span></div>
            <div class="d-nav-item" onclick="dJump(2)">üè≥Ô∏è<span>LOC</span></div>
            <div class="d-nav-item" onclick="dJump(3)">üë§<span>USER</span></div>
            <div class="d-nav-item" onclick="dJump(4)">üîë<span>PASS</span></div>
            <div class="d-nav-item" onclick="dJump(5)">üîå<span>ISP</span></div>
            <div class="d-nav-item" onclick="dJump(6)">üî¢<span>IP</span></div>
            <div class="d-nav-item" onclick="dJump(7)">üìã<span>STATS</span></div>
            <div class="d-nav-item" onclick="dJump(8)">üé≤<span>TRIVIA</span></div>
            <div class="d-nav-item" onclick="dJump(9)">üòÇ<span>JOKES</span></div>
            <div class="d-nav-item" onclick="dJump(10)">‚ÑπÔ∏è<span>ABOUT</span></div>
        </nav>

        <div class="d-header-content">
            <div class="d-header-left" onclick="toggleSound()" style="cursor:pointer;">
                <h1>BOTS ARE KNOCKING <span class="status-dot"></span></h1>
                <div style="font-size: 1em; color: var(--neon-green); margin-top: -8px; margin-bottom: 12px; font-style: italic;">... BUT THEY CAN'T COME IN. &nbsp;<span id="d-header-sound" style="font-style:normal; cursor:pointer;">üîà</span></div>
                <div class="d-stats">
                    <span class="stat-label">Knocks:</span>&nbsp;<span id="d-total" class="stat-value">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="stat-label">Per Min:</span>&nbsp;<span id="d-kpm" class="stat-value">0.00</span>
                </div>
                <div class="d-stats">
                    <span class="stat-label">SINCE LAST KNOCK:</span>&nbsp;<span id="d-since" class="stat-value">-</span>
                </div>
            </div>
            <div class="d-header-right">
                <div id="d-globe-container"></div>
            </div>
        </div>
    </div>
    
    <div class="d-grid" id="d-slider-container">
        <div class="d-box" id="d-box-feed" onclick="dJump(0)"><h2>LIVE FEED: LOGIN ATTEMPTS</h2><div id="d-feed" class="d-content"></div></div>
        <div class="d-box" id="d-box-globe"><h2>GLOBE VIEW</h2><div id="d-globe-location" style="text-align:center; margin-bottom:10px;"><div id="d-globe-loc-text" style="color:var(--neon-green);"></div><div id="d-globe-loc-isp" style="color:var(--data-blue); font-size:0.85em;"></div></div><div id="d-globe-pane" class="d-content globe-pane"></div></div>
        <div class="d-box" onclick="dJump(2)"><h2>LOCATION</h2><div id="d-loc" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(3)"><h2>USERNAME</h2><div id="d-user" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(4)"><h2>PASSWORD</h2><div id="d-pass" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(5)"><h2>ISP</h2><div id="d-prov" class="d-content"></div></div>
        <div class="d-box" onclick="dJump(6)"><h2>IP ADDRESS</h2><div id="d-ip" class="d-content"></div></div>
        <div class="d-box" id="d-box-info" onclick="dJump(7)"><h2>STATS</h2><div id="d-details" class="d-content"></div></div>
        <div class="d-box" id="d-box-trivia" onclick="dJump(8)"><h2>TRIVIA</h2><div id="d-trivia" class="d-content"></div></div>
        <div class="d-box" id="d-box-jokes" onclick="dJump(9)"><h2>KNOCK-KNOCK JOKES</h2><div id="d-jokes" class="d-content" style="color:var(--neon-green); line-height:1.6;"></div></div>
        <div class="d-box" onclick="dJump(10)"><h2>ABOUT</h2><div class="d-content" style="color:var(--neon-green); line-height:1.6;">
            <div style="font-size:1.4em; font-weight:bold; margin-bottom:20px;">KNOCK-KNOCK.NET</div>
	    <p>Set up an unprotected server on the net, and the bots start swarming!</p><p> This site shows bots attempting (unsuccessfully) to break into an ordinary internet server.</p>
            <p>This constant chatter of bots knocking on the doors of machines on the net has been referred to as <em>"the background radiation of the Internet".</em></p>
	    <p>Knock-knock.net is a visualization of this bot traffic.
	    It shows the bot activity in real-time, and provides historic stats of the bot attacks over time: where they are coming from, the most common usernames and passwords attempted, the worst offending ISPs, and in some cases, why the password or username was chosen.</p>
            <p>Have fun! Send questions or comments to <a class="contact-email" href="#" style="color:var(--data-blue)"></a>.</p>
        </div></div>
    </div>
</div>

<div id="mobile-layout">
    <div class="m-header">
        <div class="m-header-content">
            <div class="m-header-left" onclick="toggleSound()" style="cursor:pointer;">
                <h1>BOTS ARE KNOCKING <span class="status-dot"></span></h1>
                <div style="font-size: 0.85em; color: var(--neon-green); margin-top: -2px; margin-bottom: 8px; font-style: italic;">... BUT THEY CAN'T COME IN. &nbsp;<span id="m-header-sound" style="font-style:normal; cursor:pointer;">üîà</span></div>
                <div class="m-stat-row">
                    <span class="stat-label">Knocks:</span>&nbsp;<span id="m-total" class="stat-value">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="stat-label">Per Min:</span>&nbsp;<span id="m-kpm" class="stat-value">0.00</span>
                </div>
                <div class="m-stat-row">
                    <span class="stat-label">SINCE LAST KNOCK:</span>&nbsp;<span id="m-since" class="stat-value">-</span>
                </div>
            </div>
            <div class="m-header-right">
                <div id="globe-container"></div>
            </div>
        </div>
    </div>
    <div class="m-progress-container"><div id="m-progress-bar"></div></div>
    <div class="m-viewport" id="m-viewport">
        <div class="m-pane" id="m-pane-feed"><h2>LIVE FEED: LOGIN ATTEMPTS</h2><div id="m-feed" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-globe"><h2>GLOBE VIEW</h2><div id="m-globe-location" style="text-align:center; margin-bottom:10px;"><div id="m-globe-loc-text" style="color:var(--neon-green);"></div><div id="m-globe-loc-isp" style="color:var(--data-blue); font-size:0.85em;"></div></div><div id="m-globe-pane" class="m-content globe-pane" style="display:flex; justify-content:center; align-items:center;"></div></div>
        <div class="m-pane" id="m-pane-loc"><h2>LOCATION</h2><div id="m-loc" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-user"><h2>USERNAME</h2><div id="m-user" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-pass"><h2>PASSWORD</h2><div id="m-pass" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-prov"><h2>ISP</h2><div id="m-prov" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-ip"><h2>IP ADDRESS</h2><div id="m-ip" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-details"><h2>STATS</h2><div id="m-details" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-trivia"><h2>TRIVIA</h2><div id="m-trivia" class="m-content"></div></div>
        <div class="m-pane" id="m-pane-jokes"><h2>KNOCK-KNOCK JOKES</h2><div id="m-jokes" class="m-content" style="color:var(--neon-green); line-height:1.6;"></div></div>
        <div class="m-pane" id="m-pane-about"><h2>ABOUT</h2><div class="m-content" style="color:var(--neon-green); line-height:1.6;">
            <div style="font-size:1.4em; font-weight:bold; margin-bottom:20px;">KNOCK-KNOCK.NET</div>
	    <p>Set up an unprotected server on the net, and the bots start swarming!</p><p> This site shows bots attempting (unsuccessfully) to break into an ordinary internet server.</p>
            <p>This constant chatter of bots knocking on the doors of machines on the net has been referred to as <em>"the background radiation of the Internet".</em></p>
	    <p>Knock-knock.net is a visualization of this bot traffic.
	    It shows the bot activity in real-time, and provides historic stats of the bot attacks over time: where they are coming from, the most common usernames and passwords attempted, the worst offending ISPs, and in some cases, why the password or username was chosen.</p>
            <p>Have fun! Send questions or comments to <a class="contact-email" href="#" style="color:var(--data-blue)"></a>.</p>
        </div></div>
    </div>
    <div class="m-footer">
        <div class="m-dots">
            <div class="dot active" onclick="jump(0)"></div><div class="dot" onclick="jump(1)"></div><div class="dot" onclick="jump(2)"></div><div class="dot" onclick="jump(3)"></div><div class="dot" onclick="jump(4)"></div><div class="dot" onclick="jump(5)"></div><div class="dot" onclick="jump(6)"></div><div class="dot" onclick="jump(7)"></div><div class="dot" onclick="jump(8)"></div><div class="dot" onclick="jump(9)"></div><div class="dot" onclick="jump(10)"></div>
        </div>
        <div class="m-nav-container">
        <nav class="m-nav">
            <div class="nav-item active" onclick="jump(0)">üì¢<span>FEED</span></div>
            <div class="nav-item" onclick="jump(1)">üåç<span>GLOBE</span></div>
            <div class="nav-item" onclick="jump(2)">üè≥Ô∏è<span>LOC</span></div>
            <div class="nav-item" onclick="jump(3)">üë§<span>USER</span></div>
            <div class="nav-item" onclick="jump(4)">üîë<span>PASS</span></div>
            <div class="nav-item" onclick="jump(5)">üîå<span>ISP</span></div>
            <div class="nav-item" onclick="jump(6)">üî¢<span>IP</span></div>
            <div class="nav-item" onclick="jump(7)">üìã<span>STATS</span></div>
            <div class="nav-item" onclick="jump(8)">üé≤<span>TRIVIA</span></div>
            <div class="nav-item" onclick="jump(9)">üòÇ<span>JOKES</span></div>
            <div class="nav-item" onclick="jump(10)">‚ÑπÔ∏è<span>ABOUT</span></div>
        </nav>
        </div>
    </div>
</div>

<script>
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws`;
    let ws;
    let audioCtx = null;
    let soundEnabled = localStorage.getItem('soundEnabled') === 'true';

    // --- DEBUG OVERLAY (add ?debug to URL to enable) ---
    const DEBUG = new URLSearchParams(window.location.search).has('debug');
    let debugDiv = null;
    let knockCount = 0;
    const DEBUG_STORAGE_KEY = 'knock_debug_log';

    if (DEBUG) {
        debugDiv = document.createElement('div');
        debugDiv.id = 'debug-overlay';
        debugDiv.style.cssText = 'position:fixed;bottom:10px;left:10px;right:10px;max-height:40vh;overflow-y:auto;background:rgba(0,0,0,0.9);color:#0f0;font:11px monospace;padding:8px;z-index:99999;border:1px solid #0f0;border-radius:4px;';
        document.body.appendChild(debugDiv);

        // Restore previous logs from localStorage
        try {
            const prevLogs = JSON.parse(localStorage.getItem(DEBUG_STORAGE_KEY) || '[]');
            if (prevLogs.length > 0) {
                const sep = document.createElement('div');
                sep.style.cssText = 'color:#ff0;border-top:1px dashed #ff0;margin:4px 0;padding-top:4px;';
                sep.textContent = '--- PREVIOUS SESSION ---';
                debugDiv.appendChild(sep);
                prevLogs.forEach(log => {
                    const line = document.createElement('div');
                    line.textContent = log;
                    line.style.color = '#888';
                    debugDiv.appendChild(line);
                });
            }
        } catch (e) {}
    }

    function debugLog(msg) {
        if (!DEBUG || !debugDiv) return;
        const ts = new Date().toTimeString().slice(0, 8);
        const logEntry = `[${ts}] ${msg}`;
        const line = document.createElement('div');
        line.textContent = logEntry;
        debugDiv.insertBefore(line, debugDiv.firstChild);

        // Persist to localStorage
        try {
            let logs = JSON.parse(localStorage.getItem(DEBUG_STORAGE_KEY) || '[]');
            logs.unshift(logEntry);
            logs = logs.slice(0, 50); // Keep max 50
            localStorage.setItem(DEBUG_STORAGE_KEY, JSON.stringify(logs));
        } catch (e) {}

        // Keep max 100 lines in DOM (50 current + 50 previous)
        while (debugDiv.children.length > 100) debugDiv.lastChild.remove();
    }

    if (DEBUG) {
        debugLog('Debug mode enabled');
        debugLog('Pane globes pause when not visible');
        debugLog('UA: ' + navigator.userAgent.slice(0, 60));

        window.onerror = (msg, src, line, col, err) => {
            debugLog(`ERROR: ${msg} @ ${src}:${line}`);
            return false;
        };
        window.onunhandledrejection = (e) => {
            debugLog(`PROMISE ERR: ${e.reason}`);
        };
        document.addEventListener('visibilitychange', () => {
            debugLog(`Visibility: ${document.visibilityState}`);
        });
        window.addEventListener('pagehide', () => debugLog('EVENT: pagehide'));
        window.addEventListener('beforeunload', () => debugLog('EVENT: beforeunload'));
        window.addEventListener('unload', () => debugLog('EVENT: unload'));

        // Log memory usage every 30s (if available)
        setInterval(() => {
            if (performance.memory) {
                const mb = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                debugLog(`Memory: ${mb}MB`);
            }
            const feedEl = document.getElementById('m-feed');
            if (feedEl) debugLog(`Feed items: ${feedEl.children.length}`);
        }, 30000);
    }

    function updateSoundIcon() {
        const icon = soundEnabled ? 'üîä' : 'üîá';
        document.querySelectorAll('#d-header-sound, #m-header-sound').forEach(el => {
            el.innerHTML = icon;
            twemoji.parse(el);
        });
    }

    function toggleSound() {
        soundEnabled = !soundEnabled;
        localStorage.setItem('soundEnabled', soundEnabled);
        updateSoundIcon();
        if (soundEnabled) { initAudio(); audioCtx.resume().then(() => playUIClick()); }
    }

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    // Unlock audio on first user interaction
    document.addEventListener('click', initAudio, { once: true });
    document.addEventListener('touchstart', initAudio, { once: true });

    function playTone(freq, type, vol, dur) {
        if (!audioCtx) initAudio();
        if (!audioCtx || audioCtx.state === 'suspended') return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.type = type;
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        osc.start(audioCtx.currentTime);
        osc.stop(audioCtx.currentTime + dur);
    }

    function playClick() { if (soundEnabled) playTone(800, 'sine', 0.1, 0.05); }
    function playUIClick() { playTone(1200, 'triangle', 0.08, 0.08); }
    let lastKnockTime = null;
    let currentKnock = null;
    let mobileGlobe = null;
    let desktopGlobe = null;
    let lastLat = null;
    let lastLng = null;
    let countriesData = null;
    let paneGlobeDesktop = null;
    let paneGlobeMobile = null;

    // Store leaderboard data globally for ranking lookups
    let leaderboards = {
        loc: [],        // country data {iso, country, count}
        users: [],      // {label, count}
        passwords: [],  // {label, count}
        providers: [],  // {label, count}
        ips: []         // {label, count}
    };

    function getRank(list, value, key = 'label') {
        if (!list || !value) return null;
        const idx = list.findIndex(item => item[key] === value);
        return idx >= 0 ? idx + 1 : null;
    }

    function formatRank(rank) {
        if (!rank) return '';
        const lastTwo = rank % 100;
        const lastOne = rank % 10;
        let suffix = 'th';
        if (lastTwo !== 11 && lastTwo !== 12 && lastTwo !== 13) {
            if (lastOne === 1) suffix = 'st';
            else if (lastOne === 2) suffix = 'nd';
            else if (lastOne === 3) suffix = 'rd';
        }
        let star = '';
        if (rank <= 10) star = ' <span style="color:#FFD700">‚òÖ</span>';       // Gold
        else if (rank <= 50) star = ' <span style="color:#C0C0C0">‚òÖ</span>';  // Silver
        else if (rank <= 100) star = ' <span style="color:#FF4444">‚òÖ</span>'; // Red
        return ` <span style="color:var(--data-blue)">(${rank}${suffix}${star})</span>`;
    }

    // Load countries GeoJSON on startup for globe panes
    fetch('/static/countries.geojson')
        .then(res => res.json())
        .then(data => {
            countriesData = data.features;
            // Apply current style to any existing pane globe (hex polygons need countriesData)
            if (paneGlobeDesktop) applyGlobeStyle(paneGlobeDesktop, paneGlobeStyleIdx);
            if (paneGlobeMobile) applyGlobeStyle(paneGlobeMobile, paneGlobeStyleIdx);
        });

    function createGlobe(container, size) {
        const g = Globe()
            .globeImageUrl('//unpkg.com/three-globe/example/img/earth-day.jpg')
            .backgroundColor('rgba(0,0,0,0)')
            .showAtmosphere(false)
            .width(size)
            .height(size)
            .pointsData([])
            .pointAltitude(0.01)
            .pointColor(() => '#ff0000')
            .pointRadius(1.5)
            (container);

        g.controls().enableZoom = false;
        g.controls().enablePan = false;
        g.controls().autoRotate = false;
        g.pointOfView({ lat: 0, lng: 0, altitude: 1.4 });
        // Delay pause until texture has loaded and rendered
        setTimeout(() => g.pauseAnimation(), 5000);

        // Resume on user interaction, pause when done
        g.controls().addEventListener('start', () => {
            if (headerGlobePauseTimeout) clearTimeout(headerGlobePauseTimeout);
            g.resumeAnimation();
        });
        g.controls().addEventListener('end', () => {
            headerGlobePauseTimeout = setTimeout(() => {
                g.pauseAnimation();
                debugLog('Header globe paused (interaction end)');
            }, 1100);
        });

        return g;
    }

    let headerGlobePauseTimeout = null;
    let paneGlobeVisible = { desktop: false, mobile: false };
    let paneGlobePauseTimeout = null;

    function animateGlobesOnKnock() {
        // Resume all globes for animation, then pause
        if (headerGlobePauseTimeout) clearTimeout(headerGlobePauseTimeout);
        if (paneGlobePauseTimeout) clearTimeout(paneGlobePauseTimeout);

        // Header globes (always animate)
        if (mobileGlobe) mobileGlobe.resumeAnimation();
        if (desktopGlobe) desktopGlobe.resumeAnimation();

        // Pane globes (only if visible)
        if (paneGlobeDesktop && paneGlobeVisible.desktop) paneGlobeDesktop.resumeAnimation();
        if (paneGlobeMobile && paneGlobeVisible.mobile) paneGlobeMobile.resumeAnimation();

        headerGlobePauseTimeout = setTimeout(() => {
            if (mobileGlobe) mobileGlobe.pauseAnimation();
            if (desktopGlobe) desktopGlobe.pauseAnimation();
            debugLog('Header globes paused');
        }, 1100); // 1s rotation + 100ms buffer

        schedulePaneGlobePause();
    }

    function addGlobeClickHandler(container, onClick) {
        let startX, startY;
        container.addEventListener('mousedown', (e) => { startX = e.clientX; startY = e.clientY; });
        container.addEventListener('click', (e) => {
            const dist = Math.hypot(e.clientX - startX, e.clientY - startY);
            if (dist < 5) onClick();
        });
    }

    const noHeaderGlobe = new URLSearchParams(window.location.search).has('noheader');
    const noGlobePane = new URLSearchParams(window.location.search).has('noglobepane');

    function initGlobes() {
        const mobileContainer = document.getElementById('globe-container');
        const desktopContainer = document.getElementById('d-globe-container');

        if (mobileContainer && window.innerWidth <= 800 && !noHeaderGlobe) {
            mobileGlobe = createGlobe(mobileContainer, 85);
            addGlobeClickHandler(mobileContainer, () => jump(1));
        }
        if (desktopContainer && window.innerWidth > 800) {
            desktopGlobe = createGlobe(desktopContainer, 110);
            addGlobeClickHandler(desktopContainer, () => dJump(1));
        }
    }

    let citiesData = null;
    let landData = null;
    fetch('/static/cities.geojson')
        .then(r => r.json())
        .then(d => { citiesData = d.features; });
    fetch('//cdn.jsdelivr.net/npm/world-atlas@2/land-110m.json')
        .then(r => r.json())
        .then(d => { landData = topojson.feature(d, d.objects.land).features; });

    const GLOBE_STYLES = [
        { name: 'Matrix', img: '//unpkg.com/three-globe/example/img/earth-night.jpg', hex: true, outlines: false, cities: false },
        { name: 'Night', img: '//unpkg.com/three-globe/example/img/earth-night.jpg', hex: false, outlines: '#00ff41', cities: false },
        { name: 'Vectors', img: '/static/earth-black.png', hex: false, outlines: '#00ff41', cities: false },
        { name: 'Cities', img: '//unpkg.com/three-globe/example/img/earth-night.jpg', hex: false, outlines: '#5078ff', cities: true },
        { name: 'Heat', img: '/static/earth-black.png', hex: false, outlines: false, cities: false, extruded: true, viewAlt: 0.3, viewAltDesktop: 0.2 },
        { name: 'Atlas', img: '/static/marble_with_borders.jpg', hex: false, outlines: '#00ff41', cities: false },
    ];
    const savedStyle = parseInt(localStorage.getItem('globeStyle'));
    let paneGlobeStyleIdx = (savedStyle >= 0 && savedStyle < GLOBE_STYLES.length) ? savedStyle : (window.innerWidth <= 800 ? 5 : 0);

    function applyGlobeStyle(globe, idx) {
        const style = GLOBE_STYLES[idx];
        globe.globeImageUrl(style.img);
        if (style.hex && countriesData) {
            globe.hexPolygonsData(countriesData);
            globe.hexPolygonResolution(3);
            globe.hexPolygonMargin(0.4);
            globe.hexPolygonColor(() => `hsl(${140 + Math.random() * 40}, 100%, 50%)`);
            globe.polygonsData(countriesData);
            globe.polygonCapColor(() => 'rgba(0,0,0,0)');
            globe.polygonSideColor(() => 'rgba(0,0,0,0)');
            globe.polygonStrokeColor(() => '#000080');
            globe.polygonAltitude(0.01);
            globe.labelsData([]);
        } else if (style.outlines && countriesData) {
            const outlineColor = style.outlines;
            const polyData = (style.land && landData) ? landData : countriesData;
            globe.hexPolygonsData([]);
            globe.polygonsData(polyData);
            globe.polygonCapColor(() => 'rgba(0,0,0,0)');
            globe.polygonSideColor(() => 'rgba(0,0,0,0)');
            globe.polygonStrokeColor(() => outlineColor);
            globe.polygonAltitude(0.006);
            globe.labelsData([]);
        } else if (style.extruded && countriesData) {
            const hitsMap = {};
            let maxHits = 1;
            leaderboards.loc.forEach(c => {
                hitsMap[c.iso] = c.count;
                if (c.count > maxHits) maxHits = c.count;
            });
            const logMax = Math.log(1 + maxHits);
            globe.hexPolygonsData([]);
            globe.polygonsData(countriesData);
            globe.polygonCapColor(d => {
                const h = hitsMap[d.properties.ISO_A2] || 0;
                if (!h) return 'rgba(0, 255, 65, 0.05)';
                const t = Math.log(1 + h) / logMax;
                const r = Math.round(255 * t);
                const g = Math.round(255 * (1 - t));
                return `rgb(${r}, ${g}, 0)`;
            });
            globe.polygonSideColor(d => {
                const h = hitsMap[d.properties.ISO_A2] || 0;
                if (!h) return 'rgba(0,0,0,0)';
                const t = Math.log(1 + h) / logMax;
                return `rgba(255, ${Math.round(200 * (1 - t))}, 0, 0.6)`;
            });
            globe.polygonStrokeColor(() => 'rgba(0, 255, 65, 0.15)');
            globe.polygonAltitude(d => {
                const h = hitsMap[d.properties.ISO_A2] || 0;
                if (!h) return 0.002;
                return 0.002 + 0.12 * Math.log(1 + h) / logMax;
            });
            globe.labelsData([]);
        } else {
            globe.hexPolygonsData([]);
            globe.polygonsData([]);
            globe.labelsData([]);
        }
        if (style.cities && citiesData) {
            const sorted = [...citiesData].sort((a, b) => b.properties.pop_max - a.properties.pop_max);
            const top50 = new Set(sorted.slice(0, 50));
            globe.labelsData(citiesData)
                .labelLat(d => d.properties.latitude)
                .labelLng(d => d.properties.longitude)
                .labelText(d => top50.has(d) ? d.properties.name : '')
                .labelSize(d => Math.sqrt(d.properties.pop_max) * 6e-4)
                .labelDotRadius(d => Math.sqrt(d.properties.pop_max) * 4e-4)
                .labelColor(() => '#00ff41')
                .labelAltitude(0.015)
                .labelResolution(2);
        }
        globe.polygonLabel(d => d.properties && d.properties.ADMIN ? `<span style="color:#00ff41">${d.properties.ADMIN}</span>` : '');
        globe.renderer().domElement.addEventListener('mousemove', () => {
            globe.resumeAnimation();
            schedulePaneGlobePause();
        });
        globe.pointAltitude(style.extruded ? 0.15 : style.cities ? 0.025 : 0.01);
        globe.pointColor(() => style.extruded ? '#00fbff' : '#ff0000');
        const pov = globe.pointOfView();
        const isDesktop = globe === paneGlobeDesktop;
        const baseAlt = isDesktop ? 1.5 : 1.8;
        const extraAlt = (isDesktop && style.viewAltDesktop != null) ? style.viewAltDesktop : (style.viewAlt || 0);
        globe.pointOfView({ lat: pov.lat, lng: pov.lng, altitude: baseAlt + extraAlt }, 500);
        globe.resumeAnimation();
        schedulePaneGlobePause();
    }

    function cyclePaneGlobeStyle() {
        playUIClick();
        paneGlobeStyleIdx = (paneGlobeStyleIdx + 1) % GLOBE_STYLES.length;
        localStorage.setItem('globeStyle', paneGlobeStyleIdx);
        if (paneGlobeDesktop) applyGlobeStyle(paneGlobeDesktop, paneGlobeStyleIdx);
        if (paneGlobeMobile) applyGlobeStyle(paneGlobeMobile, paneGlobeStyleIdx);
        // Update button labels
        const name = GLOBE_STYLES[paneGlobeStyleIdx].name;
        document.querySelectorAll('.pane-globe-style-btn').forEach(b => b.textContent = '‚ü≥ ' + name);
    }

    function addStyleButton(parentBox) {
        parentBox.style.position = 'relative';
        const wrap = document.createElement('div');
        wrap.className = 'pane-globe-style-label';
        wrap.innerHTML = 'Style:';
        const btn = document.createElement('div');
        btn.className = 'pane-globe-style-btn';
        btn.textContent = '‚ü≥ ' + GLOBE_STYLES[paneGlobeStyleIdx].name;
        btn.addEventListener('click', (e) => { e.stopPropagation(); cyclePaneGlobeStyle(); });
        wrap.appendChild(btn);
        parentBox.appendChild(wrap);
    }

    const PANE_GLOBE_CFG = {
        desktop: { paneId: 'd-globe-pane', btnParentId: 'd-box-globe', fallbackSize: 300, altitude: 1.5, glowCap: 15 },
        mobile:  { paneId: 'm-globe-pane', btnParentId: 'm-pane-globe', fallbackSize: 250, altitude: 1.8, glowCap: 25 },
    };

    function createPaneGlobe(which) {
        if (which === 'mobile' && noGlobePane) return;
        const cfg = PANE_GLOBE_CFG[which];
        const pane = document.getElementById(cfg.paneId);
        if (!pane) return;
        const size = Math.min(pane.clientWidth, pane.clientHeight) || cfg.fallbackSize;
        const globe = Globe()
            .globeImageUrl(GLOBE_STYLES[paneGlobeStyleIdx].img)
            .backgroundColor('rgba(0,0,0,0)')
            .showAtmosphere(false)
            .width(size).height(size)
            .pointsData([])
            .pointAltitude(0.01)
            .pointColor(() => '#ff0000')
            .pointRadius(1.5)
            (pane);
        globe.controls().enableZoom = false;
        globe.controls().autoRotate = false;
        if (which === 'desktop') paneGlobeDesktop = globe; else paneGlobeMobile = globe;
        globe.onGlobeReady(() => {
            globe.pointOfView(lastLat !== null ? { lat: lastLat, lng: lastLng, altitude: cfg.altitude } : { altitude: cfg.altitude });
            const cam = globe.camera();
            const globeEdge = Math.asin(1 / (cfg.altitude + 1)) / ((cam.fov / 2) * Math.PI / 180) * 100;
            const closestSide = Math.min(pane.clientWidth, pane.clientHeight) / 2;
            const glowSpread = Math.min(globeEdge * 0.25 / 100 * closestSide, cfg.glowCap);
            const glowOuter = Math.min(globeEdge + glowSpread / closestSide * 100, 100);
            pane.style.setProperty('--globe-edge', globeEdge.toFixed(1) + '%');
            pane.style.setProperty('--glow-outer', glowOuter.toFixed(1) + '%');
            pane.classList.add('glow-active');
            applyGlobeStyle(globe, paneGlobeStyleIdx);
        });
        addStyleButton(document.getElementById(cfg.btnParentId));
    }

    function destroyPaneGlobe(which) {
        if (which === 'desktop' && paneGlobeDesktop) {
            document.getElementById('d-globe-pane')?.classList.remove('glow-active');
            document.getElementById('d-box-globe')?.querySelector('.pane-globe-style-label')?.remove();
            paneGlobeDesktop._destructor();
            paneGlobeDesktop = null;
        } else if (which === 'mobile' && paneGlobeMobile) {
            document.getElementById('m-globe-pane')?.classList.remove('glow-active');
            document.getElementById('m-pane-globe')?.querySelector('.pane-globe-style-label')?.remove();
            paneGlobeMobile._destructor();
            paneGlobeMobile = null;
        }
    }

    function initPaneGlobes() {
        setTimeout(() => {
            if (window.innerWidth > 800) createPaneGlobe('desktop');
            else if (!DEBUG) createPaneGlobe('mobile');
            setupPaneGlobeVisibility();
        }, 100);
    }

    // Switch pane globe when crossing the 800px breakpoint
    let lastWasDesktop = window.innerWidth > 800;
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            const isDesktop = window.innerWidth > 800;
            if (isDesktop === lastWasDesktop) return;
            lastWasDesktop = isDesktop;
            if (isDesktop) {
                destroyPaneGlobe('mobile');
                createPaneGlobe('desktop');
            } else if (!DEBUG) {
                destroyPaneGlobe('desktop');
                createPaneGlobe('mobile');
            }
            setupPaneGlobeVisibility();
        }, 300);
    });

    function setupPaneGlobeVisibility() {
        const targets = [
            { el: document.getElementById('d-globe-pane'), globe: () => paneGlobeDesktop, key: 'desktop' },
            { el: document.getElementById('m-globe-pane'), globe: () => paneGlobeMobile, key: 'mobile' }
        ].filter(t => t.el);

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const target = targets.find(t => t.el === entry.target);
                const globe = target?.globe();
                if (!globe) return;

                paneGlobeVisible[target.key] = entry.isIntersecting;

                if (entry.isIntersecting) {
                    // Show current state briefly, then pause
                    debugLog('Pane globe: visible, rendering');
                    globe.resumeAnimation();
                    schedulePaneGlobePause();
                } else {
                    debugLog('Pane globe: hidden, pausing');
                    globe.pauseAnimation();
                }
            });
        }, { threshold: 0.1 });

        targets.forEach(t => {
            observer.observe(t.el);
            // Add interaction handlers
            const globe = t.globe();
            if (globe) {
                globe.controls().addEventListener('start', () => {
                    if (paneGlobePauseTimeout) clearTimeout(paneGlobePauseTimeout);
                    globe.resumeAnimation();
                });
                globe.controls().addEventListener('end', () => schedulePaneGlobePause());
            }
        });
    }

    function schedulePaneGlobePause() {
        if (paneGlobePauseTimeout) clearTimeout(paneGlobePauseTimeout);
        paneGlobePauseTimeout = setTimeout(() => {
            if (paneGlobeDesktop && paneGlobeVisible.desktop) {
                paneGlobeDesktop.pauseAnimation();
            }
            if (paneGlobeMobile && paneGlobeVisible.mobile) {
                paneGlobeMobile.pauseAnimation();
            }
            debugLog('Pane globes paused');
        }, 3100); // 3s pulse animation + 100ms buffer
    }

    function pulseGlobeAtmosphere() {
        ['d-globe-pane', 'm-globe-pane'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('glow-pulse');
            void el.offsetWidth;
            el.classList.add('glow-pulse');
        });
    }

    function updateGlobeLocation(d) {
        if (!d) return;
        const loc = formatLocation(d);
        const locHtml = `${getFlag(d.iso)} ${loc}`;
        ['d-globe-loc-text', 'm-globe-loc-text'].forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.innerHTML = locHtml; twemoji.parse(el); }
        });
        ['d-globe-loc-isp', 'm-globe-loc-isp'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerText = d.isp || '';
        });
    }

    function rotateGlobeToLocation(lat, lng) {
        if (lat === null || lng === null) return;
        lastLat = lat;
        lastLng = lng;
        const point = [{ lat, lng }];

        animateGlobesOnKnock();

        [
            { g: mobileGlobe, alt: 1.4 }, { g: desktopGlobe, alt: 1.4 },
            { g: paneGlobeDesktop, alt: 1.5 + (GLOBE_STYLES[paneGlobeStyleIdx].viewAltDesktop != null ? GLOBE_STYLES[paneGlobeStyleIdx].viewAltDesktop : (GLOBE_STYLES[paneGlobeStyleIdx].viewAlt || 0)) },
            { g: paneGlobeMobile, alt: 1.8 + (GLOBE_STYLES[paneGlobeStyleIdx].viewAlt || 0) },
        ].forEach(({ g, alt }) => {
            if (!g) return;
            g.pointsData(point);
            g.pointOfView({ lat, lng, altitude: alt }, 1000);
        });
    }

    // Handle resize across breakpoint
    let lastWidth = window.innerWidth;
    window.addEventListener('resize', () => {
        const isMobile = window.innerWidth <= 800;
        const wasMobile = lastWidth <= 800;

        if (isMobile !== wasMobile) {
            // Crossed the breakpoint
            const mobileContainer = document.getElementById('globe-container');
            const desktopContainer = document.getElementById('d-globe-container');

            if (isMobile && !mobileGlobe && mobileContainer && !noHeaderGlobe) {
                mobileContainer.innerHTML = '';
                mobileGlobe = createGlobe(mobileContainer, 85);
                if (lastLat !== null) rotateGlobeToLocation(lastLat, lastLng);
            } else if (!isMobile && !desktopGlobe && desktopContainer) {
                desktopContainer.innerHTML = '';
                desktopGlobe = createGlobe(desktopContainer, 110);
                if (lastLat !== null) rotateGlobeToLocation(lastLat, lastLng);
            }
        }
        lastWidth = window.innerWidth;
    });

    setInterval(() => {
        if (lastKnockTime) {
            const secs = Math.floor(Date.now() / 1000 - lastKnockTime) + 's';
            document.getElementById('m-since').innerText = secs;
            document.getElementById('d-since').innerText = secs;
        }
    }, 1000);

    // MOBILE NAVIGATION
    function jump(idx) {
        const vp = document.getElementById('m-viewport');
        vp.scrollTo({ left: idx * vp.clientWidth, behavior: 'smooth' });
    }

    // DESKTOP ROTATION LOGIC
    function dJump(idx) {
        const container = document.getElementById('d-slider-container');
        const boxes = Array.from(container.children);
        const navItems = document.querySelectorAll('.d-nav-item');

        navItems.forEach((item, i) => item.classList.toggle('active', i === idx));

        boxes.forEach((box, i) => {
            let newOrder = (i - idx + boxes.length) % boxes.length;
            box.style.order = newOrder + 1;
            box.classList.toggle('is-active', i === idx);
        });
    }

    const getFlag = (iso) => {
        if (iso === 'XX' || !iso) return 'üè¥‚Äç‚ò†Ô∏è';
        return iso.toUpperCase().replace(/./g, char => String.fromCodePoint(char.charCodeAt(0) + 127397));
    };

    function renderBars(prefix, data, colorClass = '', useFlags = false) {
        ['d-', 'm-'].forEach(layout => {
            const container = document.getElementById(layout + prefix);
            if (!container) return;
            container.innerHTML = '';
            if (!data || data.length === 0) return;
            const max = data[0].count;
            data.forEach(item => {
                const pct = (item.count / max) * 100;
                let label = useFlags ? `${getFlag(item.iso)} ${item.country}` : (item.label || item.country);
                // Format IPv6 addresses in IP leaderboard
                if (prefix === 'ip' && label) label = formatIP(label);
                const rawId = useFlags ? item.iso : (item.label || item.country || item.isp);
                const div = document.createElement('div');
                div.className = 'bar-row';
                div.setAttribute('data-id', `${prefix}-${rawId}`);
                div.setAttribute('data-count', item.count);
                div.innerHTML = `<div class="bar-label"><span>${label}</span><span style="color:#ffcc00">${item.count.toLocaleString()}</span></div><div class="bar-bg"><div class="bar-fill ${colorClass}" style="width: ${pct}%"></div></div>`;
                container.appendChild(div);
                if (useFlags) twemoji.parse(div);
            });
        });
    }

    const fillClasses = { loc: 'loc-fill', pass: 'password-fill', prov: 'provider-fill', user: 'user-fill', ip: 'ip-fill' };

    function incrementAndSort(prefix, id, displayName) {
        ['d-', 'm-'].forEach(layout => {
            const container = document.getElementById(layout + prefix);
            if (!container) return;
            const uniqueId = `${prefix}-${id}`;
            let row = container.querySelector(`.bar-row[data-id="${CSS.escape(uniqueId)}"]`);
            let newCount;

            if (!row) {
                let label = id;
                if (prefix === 'loc') label = `${getFlag(id)} ${displayName || id}`;
                else if (prefix === 'ip') label = formatIP(id);
                row = document.createElement('div');
                row.className = 'bar-row';
                row.setAttribute('data-id', uniqueId);
                row.setAttribute('data-count', 1);
                row.innerHTML = `<div class="bar-label"><span>${label}</span><span style="color:#ffcc00">1</span></div><div class="bar-bg"><div class="bar-fill ${fillClasses[prefix] || ''}" style="width: 0%"></div></div>`;
                container.appendChild(row);
                if (prefix === 'loc') twemoji.parse(row);
                newCount = 1;
            } else {
                const countSpan = row.querySelector('span:last-child');
                newCount = (parseInt(countSpan.innerText.replace(/\D/g, '')) || 0) + 1;
                countSpan.innerText = newCount.toLocaleString();
                row.setAttribute('data-count', newCount);
            }

            if (row.highlightAnimation) row.highlightAnimation.cancel();
            row.highlightAnimation = row.animate([
                { background: 'rgba(0, 255, 65, 0.4)' },
                { background: 'transparent' }
            ], { duration: 3000, easing: 'ease' });

            const rows = Array.from(container.children);
            rows.sort((a, b) => (parseInt(b.getAttribute('data-count')) || 0) - (parseInt(a.getAttribute('data-count')) || 0));
            const max = parseInt(rows[0].getAttribute('data-count')) || 1;
            rows.forEach(el => {
                container.appendChild(el); 
                el.querySelector('.bar-fill').style.width = ((parseInt(el.getAttribute('data-count')) || 0) / max * 100) + '%';
            });
        });
    }

    function formatLocation(d) {
        const hasCity = d.city && d.city !== 'Unknown';
        const hasRegion = d.region && d.region !== 'Unknown';

        if (!hasCity && !hasRegion) return `Somewhere in ${d.country}`;
        if (!hasCity && hasRegion) return `${d.region}, ${d.country}`;
        if (hasCity && hasRegion) return `${d.city}, ${d.region}, ${d.country}`;
        return `${d.city}, ${d.country}`;
    }

    function formatIP(ip) {
        if (!ip) return '';
        // IPv6 addresses contain colons; IPv4 don't
        if (ip.includes(':')) {
            // Truncate IPv6: show first 2 and last 2 segments
            const parts = ip.split(':');
            if (parts.length > 4) {
                const truncated = `${parts[0]}:${parts[1]}:‚Ä¶:${parts[parts.length - 1]}`;
                return `<span title="${ip}" style="cursor:help">${truncated}</span>`;
            }
        }
        return ip;
    }

    function renderKnock(d, isNew = true) {
        const loc = formatLocation(d);
        
        const html = `
            <div class="knock-location"><strong>${getFlag(d.iso)}</strong> <strong>${loc}</strong></div>
            <span style="color:var(--ui-label)">user:</span> <span>${d.user}</span>
            <span style="color:var(--ui-label); margin-left:10px;">password:</span> <span class="knock-pass">${d.pass}</span><br>
            <span class="knock-meta"><span style="color:var(--ui-label)">ISP:</span> <span style="color:var(--data-blue)">${d.isp}</span> <span style="color:var(--ui-label); margin-left:10px;">IP:</span> <span style="color:var(--data-blue)">${formatIP(d.ip)}</span></span>
        `;

        ['d-feed', 'm-feed'].forEach(id => {
            const el = document.getElementById(id);
            const div = document.createElement('div');
            div.className = 'knock' + (isNew ? ' new-knock-flash' : '');
            div.innerHTML = html;
            if (isNew) el.prepend(div); else el.appendChild(div);
            twemoji.parse(div);
            if (el.children.length > 100) el.lastChild.remove();
        });
    }

    function formatTimeSince(lastSeen) {
        if (!lastSeen) return '<span style="color:#FF4444">never</span>';
        const now = new Date();
        // Handle SQLite datetime format (space instead of T), add Z for UTC
        const then = new Date(lastSeen.replace(' ', 'T') + 'Z');
        let secs = Math.floor((now - then) / 1000);
        if (secs < 0 || isNaN(secs)) secs = 0;
        if (secs < 60) return `${secs}s ago`;
        const mins = Math.floor(secs / 60);
        const remSecs = secs % 60;
        if (mins < 60) return `${mins}m ${remSecs}s ago`;
        const hours = Math.floor(mins / 60);
        const remMins = mins % 60;
        if (hours < 24) return `${hours}h ${remMins}m ago`;
        const days = Math.floor(hours / 24);
        const remHours = hours % 24;
        return `${days}d ${remHours}h ago`;
    }

    function renderInfo(d) {
        const loc = formatLocation(d);

        // Get rankings from leaderboards
        const countryRank = formatRank(getRank(leaderboards.loc, d.iso, 'iso'));
        const userRank = formatRank(getRank(leaderboards.users, d.user));
        const passRank = formatRank(getRank(leaderboards.passwords, d.pass));
        const ispRank = formatRank(getRank(leaderboards.providers, d.isp));
        const ipRank = formatRank(getRank(leaderboards.ips, d.ip));

        const html = `
            <div class="info-section" style="font-size:1.1em; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #333;">
                <div class="knock-location"><strong>${getFlag(d.iso)}</strong> <strong>${loc}</strong></div>
                <span style="color:var(--ui-label)">user:</span> <span>${d.user}</span>
                <span style="color:var(--ui-label); margin-left:10px;">password:</span> <span class="knock-pass">${d.pass}</span><br>
                <span class="knock-meta"><span style="color:var(--ui-label)">ISP:</span> <span style="color:var(--data-blue)">${d.isp}</span> <span style="color:var(--ui-label); margin-left:10px;">IP:</span> <span style="color:var(--data-blue)">${formatIP(d.ip)}</span></span>
            </div>
            <div class="info-item" style="margin-bottom:12px;">
                <div><span style="color:var(--ui-label)">country:</span> <span style="color:var(--neon-green)">${d.country}${countryRank}</span></div>
                <div><span style="color:var(--ui-label)">count:</span> <span style="color:var(--neon-green)">${(d.country_hits || 0).toLocaleString()}</span></div>
                <div><span style="color:var(--ui-label)">last seen:</span> <span style="color:var(--neon-green)">${formatTimeSince(d.country_last)}</span></div>
            </div>
            <div class="info-item" style="margin-bottom:12px;">
                <div><span style="color:var(--ui-label)">user:</span> <span style="color:var(--neon-green)">${d.user}${userRank}</span></div>
                <div><span style="color:var(--ui-label)">count:</span> <span style="color:var(--neon-green)">${(d.user_hits || 0).toLocaleString()}</span></div>
                <div><span style="color:var(--ui-label)">last seen:</span> <span style="color:var(--neon-green)">${formatTimeSince(d.user_last)}</span></div>
            </div>
            <div class="info-item" style="margin-bottom:12px;">
                <div><span style="color:var(--ui-label)">password:</span> <span style="color:var(--neon-green)">${d.pass}${passRank}</span></div>
                <div><span style="color:var(--ui-label)">count:</span> <span style="color:var(--neon-green)">${(d.pass_hits || 0).toLocaleString()}</span></div>
                <div><span style="color:var(--ui-label)">last seen:</span> <span style="color:var(--neon-green)">${formatTimeSince(d.pass_last)}</span></div>
            </div>
            <div class="info-item" style="margin-bottom:12px;">
                <div><span style="color:var(--ui-label)">ISP:</span> <span style="color:var(--neon-green)">${d.isp}${ispRank}</span></div>
                <div><span style="color:var(--ui-label)">count:</span> <span style="color:var(--neon-green)">${(d.isp_hits || 0).toLocaleString()}</span></div>
                <div><span style="color:var(--ui-label)">last seen:</span> <span style="color:var(--neon-green)">${formatTimeSince(d.isp_last)}</span></div>
            </div>
            <div class="info-item" style="margin-bottom:12px;">
                <div><span style="color:var(--ui-label)">IP:</span> <span style="color:var(--neon-green)">${formatIP(d.ip)}${ipRank}</span></div>
                <div><span style="color:var(--ui-label)">count:</span> <span style="color:var(--neon-green)">${(d.ip_hits || 0).toLocaleString()}</span></div>
                <div><span style="color:var(--ui-label)">last seen:</span> <span style="color:var(--neon-green)">${formatTimeSince(d.ip_last)}</span></div>
            </div>
        `;
        ['d-details', 'm-details'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = html;
            twemoji.parse(el);
        });
    }

    function renderTrivia(d) {
        if (!d) return;
        const loc = formatLocation(d);

        // Build trivia content
        let triviaItems = [];

        // User trivia (blue)
        const userFacts = triviaUserMap[d.user];
        if (userFacts && userFacts.length > 0) {
            const fact = userFacts[Math.floor(Math.random() * userFacts.length)];
            triviaItems.push(`<p style="margin-bottom:12px;"><span style="color:var(--ui-label)">User trivia:</span> <span style="color:var(--data-blue)">${fact}</span></p>`);
        }

        // Password trivia (blue) - from JSON or computed
        const passFacts = triviaPassMap[d.pass];
        if (passFacts && passFacts.length > 0) {
            const fact = passFacts[Math.floor(Math.random() * passFacts.length)];
            triviaItems.push(`<p style="margin-bottom:12px;"><span style="color:var(--ui-label)">Password trivia:</span> <span style="color:var(--data-blue)">${fact}</span></p>`);
        } else {
            // Try computed trivia rules
            const computed = getComputedPassTrivia(d);
            if (computed) {
                triviaItems.push(`<p style="margin-bottom:12px;"><span style="color:var(--ui-label)">Password trivia:</span> <span style="color:var(--data-blue)">${computed}</span></p>`);
            }
        }

        // Country trivia (blue) - cycles through facts starting from random position
        const countryData = triviaCountryMap[d.country];
        if (countryData && countryData.facts && countryData.facts.length > 0) {
            // Initialize index randomly if first time seeing this country
            if (countryData.index === undefined) {
                countryData.index = Math.floor(Math.random() * countryData.facts.length);
            }
            const fact = countryData.facts[countryData.index];
            // Advance to next index for next time
            countryData.index = (countryData.index + 1) % countryData.facts.length;
            triviaItems.push(`<p style="margin-bottom:12px;"><span style="color:var(--ui-label)">Country trivia:</span> <span style="color:var(--data-blue)">${fact}</span></p>`);
        }

        // Fallback if no trivia or still loading
        let triviaContent;
        if (!triviaLoaded) {
            triviaContent = '<p style="color:var(--ui-grey-dim); font-style:italic;">Loading trivia...</p>';
        } else if (triviaItems.length > 0) {
            triviaContent = triviaItems.join('');
        } else {
            triviaContent = '<p style="color:var(--ui-grey-dim); font-style:italic;">Sorry, I\'ve got nothing.</p>';
        }

        const html = `
            <div class="info-section" style="font-size:1.1em; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #333;">
                <div class="knock-location"><strong>${getFlag(d.iso)}</strong> <strong>${loc}</strong></div>
                <span style="color:var(--ui-label)">user:</span> <span>${d.user}</span>
                <span style="color:var(--ui-label); margin-left:10px;">password:</span> <span class="knock-pass">${d.pass}</span><br>
                <span class="knock-meta"><span style="color:var(--ui-label)">ISP:</span> <span style="color:var(--data-blue)">${d.isp}</span> <span style="color:var(--ui-label); margin-left:10px;">IP:</span> <span style="color:var(--data-blue)">${formatIP(d.ip)}</span></span>
            </div>
            <div style="line-height:1.6;">
                ${triviaContent}
            </div>
        `;
        ['d-trivia', 'm-trivia'].forEach(id => {
            const el = document.getElementById(id);
            el.innerHTML = html;
            twemoji.parse(el);
        });
    }

    function connect() {
        if (ws) ws.close();
        debugLog('WS: connecting...');
        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
            debugLog('WS: connected');
            document.querySelectorAll('.status-dot').forEach(d => d.classList.add('status-online'));
        };
        ws.onclose = (e) => {
            debugLog(`WS: closed (code=${e.code}, reason=${e.reason || 'none'})`);
            document.querySelectorAll('.status-dot').forEach(d => d.classList.remove('status-online'));
            setTimeout(connect, 3000);
        };
        ws.onerror = (e) => debugLog('WS: error event');
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const d = msg.data;
            if (msg.type === 'new_knock') {
                knockCount++;
                debugLog(`Knock #${knockCount} from ${d.iso || '??'}`);
                playClick();
                pulseGlobeAtmosphere();
                lastKnockTime = Math.floor(Date.now() / 1000);
                document.getElementById('m-since').innerText = '0s';
                document.getElementById('d-since').innerText = '0s';
                renderKnock(d, true);
                ['d-total', 'm-total'].forEach(id => document.getElementById(id).innerText = d.total_global.toLocaleString());
                ['d-kpm', 'm-kpm'].forEach(id => document.getElementById(id).innerText = d.kpm);
                incrementAndSort('loc', d.iso, d.country);
                incrementAndSort('pass', d.pass);
                incrementAndSort('prov', d.isp);
                incrementAndSort('user', d.user);
                incrementAndSort('ip', d.ip);
                currentKnock = d;
                renderInfo(d);
                scheduleTrivia(d);
                updateGlobeLocation(d);
                rotateGlobeToLocation(d.lat, d.lng);
            }
            else if (msg.type === 'init_stats') {
                debugLog(`init_stats received (total=${d.total})`);
                ['d-total', 'm-total'].forEach(id => document.getElementById(id).innerText = (d.total || 0).toLocaleString());
                ['d-kpm', 'm-kpm'].forEach(id => document.getElementById(id).innerText = d.kpm || '0.00');
                if (d.last_knock_time) {
                    lastKnockTime = d.last_knock_time;
                    const secs = Math.floor(Date.now() / 1000 - lastKnockTime) + 's';
                    document.getElementById('m-since').innerText = secs;
                    document.getElementById('d-since').innerText = secs;
                }
                if (d.last_lat !== null && d.last_lng !== null) {
                    rotateGlobeToLocation(d.last_lat, d.last_lng);
                }
                // Store leaderboards globally for ranking lookups
                leaderboards.loc = d.top_locations || [];
                leaderboards.passwords = d.top_passwords || [];
                leaderboards.providers = d.top_providers || [];
                leaderboards.users = d.top_users || [];
                leaderboards.ips = d.top_ips || [];
                // Re-apply style if it depends on leaderboard data (e.g. Heat extrusions)
                if (GLOBE_STYLES[paneGlobeStyleIdx].extruded || GLOBE_STYLES[paneGlobeStyleIdx].hex) {
                    if (paneGlobeDesktop) applyGlobeStyle(paneGlobeDesktop, paneGlobeStyleIdx);
                    if (paneGlobeMobile) applyGlobeStyle(paneGlobeMobile, paneGlobeStyleIdx);
                }

                const preScroll = vp.scrollLeft;
                renderBars('loc', d.top_locations, 'loc-fill', true);
                renderBars('pass', d.top_passwords, 'password-fill');
                renderBars('prov', d.top_providers, 'provider-fill');
                renderBars('user', d.top_users, 'user-fill');
                renderBars('ip', d.top_ips, 'ip-fill');
                if (vp.scrollLeft !== preScroll) debugLog(`‚ö†Ô∏è SCROLL SHIFTED during init_stats: ${preScroll} ‚Üí ${vp.scrollLeft}`);
                if (d.history) {
                    ['d-feed', 'm-feed'].forEach(id => document.getElementById(id).innerHTML = '');
                    d.history.forEach(k => renderKnock(k, false));
                    if (d.history.length > 0) updateGlobeLocation(d.history[0]);
                }
                // Render Stats and Trivia panes with enriched last knock data
                if (d.last_knock_stats) {
                    currentKnock = d.last_knock_stats;
                    renderInfo(d.last_knock_stats);
                    scheduleTrivia(d.last_knock_stats);
                }
            }
        };
    }

    const vp = document.getElementById('m-viewport');
    let lastPaneIdx = 0;
    vp.addEventListener('scroll', () => {
        const scrolled = (vp.scrollLeft / (vp.scrollWidth - vp.clientWidth)) * 100;
        document.getElementById('m-progress-bar').style.width = scrolled + '%';
        const currentIdx = Math.round(vp.scrollLeft / vp.clientWidth);
        if (currentIdx !== lastPaneIdx) {
            debugLog(`PANE CHANGE: ${lastPaneIdx} ‚Üí ${currentIdx}`);
            lastPaneIdx = currentIdx;
        }
    });

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const idx = Array.from(entry.target.parentNode.children).indexOf(entry.target);
                document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i === idx));
                document.querySelectorAll('.nav-item').forEach((n, i) => {
                    n.classList.toggle('active', i === idx);
                    if (i === idx) n.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                });
            }
        });
    }, { root: vp, threshold: 0.6 });
    document.querySelectorAll('.m-pane').forEach(p => observer.observe(p));

    // --- TRIVIA PANE LOGIC ---
    const TRIVIA_MIN_DISPLAY_SECONDS = 12;
    let triviaUserMap = {};      // user -> facts array
    let triviaPassMap = {};      // pass -> facts array
    let triviaCountryMap = {};   // country -> {facts: [...], index: n}
    let triviaLastRenderTime = 0;
    let triviaPendingKnock = null;
    let triviaTimeout = null;
    let triviaLoaded = false;

    function scheduleTrivia(d) {
        const now = Date.now();
        const elapsed = (now - triviaLastRenderTime) / 1000;

        if (elapsed >= TRIVIA_MIN_DISPLAY_SECONDS) {
            // Enough time has passed, render immediately
            renderTrivia(d);
            triviaLastRenderTime = now;
            triviaPendingKnock = null;
        } else {
            // Too soon, queue this knock
            triviaPendingKnock = d;
            if (!triviaTimeout) {
                const remaining = (TRIVIA_MIN_DISPLAY_SECONDS - elapsed) * 1000;
                triviaTimeout = setTimeout(() => {
                    triviaTimeout = null;
                    if (triviaPendingKnock) {
                        renderTrivia(triviaPendingKnock);
                        triviaLastRenderTime = Date.now();
                        triviaPendingKnock = null;
                    }
                }, remaining);
            }
        }
    }

    function colorizeKey(fact, key) {
        // Replace all occurrences of the key as a standalone word with green-colored version
        const escaped = key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`\\b${escaped}\\b`, 'g');
        return fact.replace(regex, `<span style="color:var(--neon-green)">${key}</span>`);
    }

    function greenText(text) {
        return `<span style="color:var(--neon-green)">${text}</span>`;
    }

    // Computed trivia rules - each returns HTML string or null
    const computedPassRules = [
        // Rule: Username equals password
        (d) => {
            if (d.user === d.pass) {
                return `The user and password are both ${greenText(d.pass)}. Pro tip: Don't double up.`;
            }
            return null;
        },
        // Rule: Username is prefix of password
        (d) => {
            if (d.pass.startsWith(d.user) && d.pass.length > d.user.length) {
                const suffix = d.pass.slice(d.user.length);
                return `This password is simply the user with a suffix added: ${greenText(d.user + ' + ' + suffix)}. Don't be simple.`;
            }
            return null;
        }
    ];

    function getComputedPassTrivia(d) {
        for (const rule of computedPassRules) {
            const result = rule(d);
            if (result) return result;
        }
        return null;
    }

    function loadTriviaData() {
        fetch('/static/user_trivia.json')
            .then(r => r.json())
            .then(data => {
                data.forEach(item => {
                    triviaUserMap[item.user] = item.facts.map(f => colorizeKey(f, item.user));
                });
            })
            .catch(err => console.error('Failed to load user trivia:', err));

        fetch('/static/password_trivia.json')
            .then(r => r.json())
            .then(data => {
                data.forEach(item => {
                    triviaPassMap[item.pass] = item.facts.map(f => colorizeKey(f, item.pass));
                });
            })
            .catch(err => console.error('Failed to load password trivia:', err));

        fetch('/static/country_trivia10.json')
            .then(r => r.json())
            .then(data => {
                data.forEach(item => {
                    triviaCountryMap[item.country] = {
                        facts: item.facts.map(f => colorizeKey(f, item.country))
                    };
                });
                triviaLoaded = true;
                // Re-render with current knock if available
                if (currentKnock) renderTrivia(currentKnock);
            })
            .catch(err => console.error('Failed to load country trivia:', err));
    }

    function setupTriviaObserver() {
        const targets = [document.getElementById('d-trivia'), document.getElementById('m-trivia')].filter(el => el);
        const observer = new IntersectionObserver((entries) => {
            if (entries.some(e => e.isIntersecting) && !triviaLoaded) {
                loadTriviaData();
            }
        }, { threshold: 0.1 });
        targets.forEach(t => observer.observe(t));
    }

    // --- JOKES PANE LOGIC ---
    let jokesData = null;
    let jokeIndex = 0;
    let jokeTimeouts = [];
    let jokesVisible = false;

    function shuffleArray(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    }

    function clearJokeTimeouts() {
        jokeTimeouts.forEach(t => clearTimeout(t));
        jokeTimeouts = [];
    }

    function displayJoke() {
        if (!jokesData || !jokesVisible) return;
        clearJokeTimeouts();

        const joke = jokesData[jokeIndex];
        const intro = `<p style="margin-bottom:15px;">Here are some knock knock jokes, courtesy of ChatGPT. You may not find them funny, but to an LLM they are hilarious.</p>`;

        ['d-jokes', 'm-jokes'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = intro + `<div id="${id}-content" style="font-size:1.2em;"></div>`;
        });

        const updateContent = (html) => {
            ['d-jokes-content', 'm-jokes-content'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = html;
            });
        };

        let lines = '';
        // Line 1: "Knock Knock"
        lines = `<div style="color:var(--warning-yellow);">Knock Knock</div>`;
        updateContent(lines);

        // Line 2: "Who's there?" after 2 seconds
        jokeTimeouts.push(setTimeout(() => {
            if (!jokesVisible) return;
            lines += `<div style="color:var(--neon-green);">Who's there?</div>`;
            updateContent(lines);
        }, 2000));

        // Line 3: The "who" after 2 more seconds (4 total)
        jokeTimeouts.push(setTimeout(() => {
            if (!jokesVisible) return;
            lines += `<div style="color:var(--warning-yellow);">${joke.who}</div>`;
            updateContent(lines);
        }, 4000));

        // Line 4: "{who}, who?" after 2 more seconds (6 total)
        jokeTimeouts.push(setTimeout(() => {
            if (!jokesVisible) return;
            lines += `<div style="color:var(--neon-green);">${joke.who}, who?</div>`;
            updateContent(lines);
        }, 6000));

        // Line 5: The punchline after 3 more seconds (9 total)
        jokeTimeouts.push(setTimeout(() => {
            if (!jokesVisible) return;
            lines += `<div style="color:var(--warning-yellow); margin-top:10px; font-style:italic;">${joke.joke}</div>`;
            updateContent(lines);
        }, 9000));

        // Next joke after 5 more seconds (14 total)
        jokeTimeouts.push(setTimeout(() => {
            if (!jokesVisible) return;
            jokeIndex = (jokeIndex + 1) % jokesData.length;
            displayJoke();
        }, 14000));
    }

    function initJokes() {
        if (jokesData) {
            displayJoke();
            return;
        }
        fetch('/static/chatgpt-knock-knock.json')
            .then(res => res.json())
            .then(data => {
                jokesData = shuffleArray(data);
                jokeIndex = 0;
                displayJoke();
            })
            .catch(err => console.error('Failed to load jokes:', err));
    }

    function setupJokesObserver() {
        const targets = [document.getElementById('d-jokes'), document.getElementById('m-jokes')].filter(el => el);
        const observer = new IntersectionObserver((entries) => {
            const isVisible = entries.some(e => e.isIntersecting);
            if (isVisible && !jokesVisible) {
                jokesVisible = true;
                initJokes();
            } else if (!isVisible && jokesVisible) {
                jokesVisible = false;
                clearJokeTimeouts();
            }
        }, { threshold: 0.3 });
        targets.forEach(t => observer.observe(t));
    }

    // iOS Safari/Chrome tab restoration fix: force layout recalc on visibility change
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            // Force layout recalculation by briefly changing height
            const ml = document.getElementById('mobile-layout');
            if (ml && window.innerWidth <= 800) {
                ml.style.height = '99.9dvh';
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        ml.style.height = '';
                    });
                });
            }
        }
    });

    window.addEventListener('load', () => {
        dJump(0);
        initGlobes();
        initPaneGlobes();
        setupJokesObserver();
        setupTriviaObserver();
        updateSoundIcon();

        // Add drag-aware click handler for desktop GLOBE pane
        const globeBox = document.getElementById('d-box-globe');
        if (globeBox) {
            addGlobeClickHandler(globeBox, () => dJump(1));
        }

        // Obfuscated email assembly (anti-harvester)
        const u = 'support', d = 'knock-knock', t = 'net';
        const addr = u + '@' + d + '.' + t;
        document.querySelectorAll('.contact-email').forEach(el => {
            el.href = 'mai' + 'lto:' + addr;
            el.textContent = addr;
        });
    });
    connect();
</script>
</body>
</html>
